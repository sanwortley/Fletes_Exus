<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fletes Larga Distancia - Admin</title>

  <meta http-equiv="Cache-Control" content="no-store" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="referrer" content="no-referrer" />

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --brand:#ffcc00; --brand-2:#ffb700;
      --bg:#0b0b0b; --card:#131313; --ink:#f5f7fb; --muted:#a9b1bd; --stroke:#232323;
      --ok:#36d399; --warn:#ffd95a; --bad:#ff6b6b;
      --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(900px 600px at 90% -20%, #191919 0%, transparent 55%),
        radial-gradient(900px 600px at 10% -20%, #151515 0%, transparent 55%),
        var(--bg);
      color:var(--ink);
    }
    .nav{position:sticky;top:0;z-index:10;background:rgba(0,0,0,.6);backdrop-filter:blur(8px);border-bottom:1px solid var(--stroke)}
    .nav-inner{max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:16px;padding:12px 18px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(180deg,var(--brand),var(--brand-2));box-shadow:0 0 18px var(--brand)}
    .nav-links{margin-left:auto;display:flex;gap:12px;align-items:center}
    .nav-links a{opacity:.9;color:var(--ink);text-decoration:none;padding:6px 10px;border-radius:10px}
    .nav-links a:hover{opacity:1;background:#171717}
    .nav-links .active{background:#171717}
    .btn-out{background:#171717;border:1px solid var(--stroke);color:var(--ink);padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer}
    .btn-out:hover{filter:brightness(1.1)}

    .container{max-width:1100px;margin:28px auto;padding:0 18px}
    h1{margin:10px 0 18px;font-size:38px}
    .accent{background:linear-gradient(180deg,var(--brand),var(--brand-2));-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 0 24px rgba(255,204,0,.18)}
    .panel{background:linear-gradient(180deg,#131313,#101010);border:1px solid var(--stroke);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}

    .login-row{display:grid;grid-template-columns:1fr 1fr auto auto;gap:12px;align-items:center;background:#0e0e0e;border:1px solid var(--stroke);border-radius:14px;padding:12px;margin-bottom:18px}
    .input{background:#0c0c0c;border:1px solid var(--stroke);color:var(--ink);border-radius:12px;padding:12px;outline:none}
    .input::placeholder{color:#7f8893}
    .btn{border:none;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer;transition:transform .08s ease,filter .15s ease}
    .btn-primary{background:linear-gradient(180deg,var(--brand),var(--brand-2));color:#111;box-shadow:0 8px 20px rgba(255,204,0,.28)}
    .btn-primary:active{transform:translateY(1px)}
    .tag{font-size:12px;font-weight:700}
    .tag.ok{color:var(--ok)} .tag.bad{color:var(--bad)} .tag.muted{color:var(--muted)}

    .table{width:100%;border-collapse:separate;border-spacing:0 10px}
    .thead th{color:var(--muted);text-align:left;padding:0 12px 8px;font-size:14px}
    .row{background:#101010;border:1px solid var(--stroke);border-radius:14px;box-shadow:var(--shadow)}
    .row td{padding:14px 12px;vertical-align:middle}
    .client{display:flex;flex-direction:column;gap:4px}
    .client .name{font-weight:700}
    .client .sub{color:var(--muted);font-size:13px}
    .badge{display:inline-flex;align-items:center;padding:8px 12px;font-weight:800;letter-spacing:.4px;border-radius:999px;border:1px solid transparent;font-size:12px}
    .aprobado{color:#0f3;background:rgba(0,255,120,.08);border-color:rgba(0,255,120,.25)}
    .pendiente{color:#ffd95a;background:rgba(255,217,90,.08);border-color:rgba(0,255,90,.25)}
    .rechazado{color:#ff8b8b;background:rgba(255,107,107,.12);border-color:rgba(255,107,107,.25)}
    .btn-ghost{background:transparent;color:var(--ink);border:1px solid #2a2a2a;padding:8px 12px;border-radius:10px;font-weight:700}
    .btn-ghost:hover{filter:brightness(1.15)}
    .actions{display:flex;gap:8px;justify-content:flex-end}
    .empty{color:var(--muted);text-align:center;padding:16px 8px}

    .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.65);display:none;justify-content:center;align-items:center;z-index:999}
    .overlay.open{display:flex}

    .modal{
      background:#111;color:#fff;border-radius:12px;box-shadow:0 0 20px rgba(255,204,0,.3);
      width:90%;max-width:700px;max-height:90vh;overflow-y:auto;padding:20px 25px;display:flex;flex-direction:column;gap:16px;
      animation:fadeIn .25s ease-out;
    }
    .modal-head{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #333;padding-bottom:8px}
    .modal-title{font-size:1.4em;font-weight:700;color:var(--brand)}
    .modal-close{background:transparent;color:#aaa;border:none;font-size:1.4em;cursor:pointer;transition:color .2s}
    .modal-close:hover{color:var(--brand)}
    .modal-body{display:flex;flex-direction:column;gap:12px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:10px}
    .kv{background:#181818;padding:10px 14px;border-radius:8px}
    .kv small{display:block;font-size:.8em;color:#aaa}
    .kv strong{font-size:1em;color:#fff}
    .kv.total{grid-column:1 / -1;text-align:right}
    #overlay .modal-foot{display:flex;justify-content:space-between;align-items:center;border-top:1px solid #333;padding-top:12px}
    #m_total{font-size:1.6em;color:var(--brand);font-weight:900}

    .btn-danger{background:#2b0b0b;border:1px solid #3a1616;color:#ffb3b3;padding:10px 12px;border-radius:10px;font-weight:800}
    .btn-reject{background:#2b160b;border:1px solid #3a2316;color:#ffc9a1;padding:10px 12px;border-radius:10px;font-weight:800}
    .btn-ok{background:linear-gradient(180deg,var(--brand),var(--brand-2));color:#111;padding:11px 16px;border-radius:12px;font-weight:900;border:none}

    .toast{position:fixed;bottom:18px;right:18px;background:#111;border:1px solid var(--stroke);padding:12px 14px;border-radius:12px;box-shadow:var(--shadow);display:none}
    .toast.show{display:block}

    /* ====== SWITCH VISTAS ====== */
    .view-switch{display:flex;gap:10px;margin:0 0 14px;flex-wrap:wrap}
    .view-tab{
      background:#171717;border:1px solid var(--stroke);color:var(--ink);
      padding:10px 12px;border-radius:12px;font-weight:800;cursor:pointer
    }
    .view-tab:hover{filter:brightness(1.12)}
    .view-tab.active{
      background:linear-gradient(180deg,var(--brand),var(--brand-2));
      color:#111;border-color:transparent;box-shadow:0 8px 20px rgba(255,204,0,.18)
    }

    /* ====== DISPONIBILIDAD ====== */
    #panelDisponibilidad{display:none}
    .disp-head{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin-bottom:12px;
    }
    .disp-left{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      background:#0e0e0e; border:1px solid var(--stroke);
      padding:10px 12px; border-radius:14px;
    }
    .chip label{color:var(--muted); font-weight:700; font-size:12px}
    .chip input[type="date"]{
      background:#0c0c0c; color:var(--ink); border:1px solid var(--stroke);
      padding:10px 12px; border-radius:12px; outline:none;
    }
    .mini-btn{
      background:#171717; border:1px solid var(--stroke); color:var(--ink);
      padding:10px 12px; border-radius:12px; font-weight:900; cursor:pointer;
    }
    .mini-btn:hover{filter:brightness(1.12)}
    .mini-btn.primary{
      background:linear-gradient(180deg,var(--brand),var(--brand-2));
      color:#111; border-color:transparent;
    }
    .status-pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px; border-radius:999px;
      border:1px solid var(--stroke); background:#0e0e0e; font-weight:900;
    }
    .status-pill.on{ color:var(--ok); }
    .status-pill.off{ color:var(--bad); }

    .slots{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));
      gap:10px;
      margin-top:12px;
    }
    .slot{
      background:#101010; border:1px solid var(--stroke);
      padding:12px; border-radius:14px;
      font-weight:900; cursor:pointer; text-align:center;
      user-select:none;
    }
    .slot:hover{filter:brightness(1.08)}
    .slot.on{
      background:rgba(54,211,153,.10);
      border-color:rgba(54,211,153,.35);
      color:#bff7e4;
    }
    .slot.off{
      opacity:.55;
    }
    .disp-hint{color:var(--muted); font-size:13px; margin-top:10px}

        /* ====== CALENDARIO ====== */
    .cal-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:12px;
    }

    .cal-title{
      font-weight:900;
      padding:10px 14px;
      border-radius:12px;
      border:1px solid var(--stroke);
      background:#0e0e0e;
      min-width:220px;
      text-align:center;
    }

    .cal-grid{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:10px;
    }

    .cal-dow{
      color:var(--muted);
      font-size:12px;
      font-weight:800;
      text-align:center;
    }

    .cal-cell{
      background:#0f0f0f;
      border:1px solid var(--stroke);
      border-radius:14px;
      min-height:70px;
      padding:10px;
      cursor:pointer;
      position:relative;
    }

    .cal-cell:hover{filter:brightness(1.12)}

    .cal-cell.muted{
      opacity:.4;
      cursor:default;
    }

    .cal-day{
      font-weight:900;
    }

    .cal-cell.selected{
      outline:2px solid rgba(255,204,0,.45);
    }

    .cal-detail{
      margin-top:14px;
      background:#0e0e0e;
      border:1px solid var(--stroke);
      border-radius:14px;
      padding:14px;
    }

    .cal-detail-title{
      color:var(--brand);
      font-weight:900;
      margin-bottom:8px;
    }

    .cal-item{
      background:#101010;
      border:1px solid #222;
      border-radius:12px;
      padding:12px;
      margin-bottom:10px;
    }
    .cal-num{
      display:inline-flex;
      width:28px;
      height:28px;
      align-items:center;
      justify-content:center;
      border-radius:999px;
    }

    .cal-day.has .cal-num{
      background:#fff;
      color:#111;
    }



    @media (max-width:760px){
      .login-row{grid-template-columns:1fr;gap:10px}
      .thead{display:none}
      .row{display:grid}
    }
    @keyframes fadeIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
  </style>


</head>

<body>
  <header class="nav">
    <div class="nav-inner">
      <div class="brand"><span class="dot"></span> Fletes Larga Distancia Admin</div>
      <nav class="nav-links">
        <a href="/index" data-view="/index">Inicio</a>
        <a href="/presupuesto" data-view="/presupuesto">Presupuesto</a>
        <strong class="active">Admin</strong>
        <button id="btnLogout" class="btn-out" style="display:none" onclick="Admin.logout()" type="button">Cerrar sesión</button>
      </nav>
    </div>
  </header>

  <main class="container">
    <h1>Panel de <span class="accent">Administración</span></h1>

    <div class="view-switch" id="viewSwitch" style="display:none">
      <button class="view-tab active" id="tabSolicitudes" type="button">Solicitudes</button>
      <button class="view-tab" id="tabCalendario">Calendario</button>
      <button class="view-tab" id="tabDisponibilidad" type="button">Disponibilidad</button>
    </div>

    <section class="panel" id="panelSolicitudes">
      <form id="loginForm" class="login-row" autocomplete="off">
        <input class="input" id="usr" type="text" placeholder="Usuario" autocomplete="username" />
        <input class="input" id="pwd" type="password" placeholder="Contraseña" autocomplete="current-password" />
        <button class="btn btn-primary" type="button" onclick="Admin.login()">Iniciar sesión</button>
        <div id="authFlag" class="tag muted">No autenticado</div>
      </form>

      <table class="table" id="tabla" style="display:none">
        <thead class="thead">
          <tr>
            <th>Cliente</th><th>Tipo</th><th>Fecha</th><th>Estado</th><th style="text-align:right">Acciones</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="5" class="empty">Iniciá sesión para ver las solicitudes de presupuesto.</td></tr>
        </tbody>
      </table>
    </section>

    <!-- ====== PANEL CALENDARIO ====== -->
<section class="panel" id="panelCalendario" style="display:none">
  <div class="cal-head">
    <button class="mini-btn" id="calPrev" type="button">←</button>
    <div class="cal-title" id="calTitle">Mes</div>
    <button class="mini-btn" id="calNext" type="button">→</button>
  </div>

  <div class="cal-grid" id="calGrid"></div>

  <div class="cal-detail" id="calDetail">
    <div class="cal-detail-title" id="calDetailTitle">
      Seleccioná un día
    </div>
    <div class="cal-detail-body" id="calDetailBody">
      Acá vas a ver los fletes del día.
    </div>
  </div>
</section>


    <section class="panel" id="panelDisponibilidad">
      <div class="disp-head">
        <div class="disp-left">
          <div class="chip">
            <label for="dispFecha">Fecha</label>
            <input id="dispFecha" type="date" />
          </div>

          <div id="dispEstado" class="status-pill off" title="Estado del día">
            ● Día deshabilitado
          </div>

          <button id="btnToggleDia" class="mini-btn" type="button">Habilitar día</button>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <button id="btnLimpiarDia" class="mini-btn" type="button">Limpiar horarios</button>
          <button id="btnGuardarDia" class="mini-btn primary" type="button">Guardar</button>
        </div>
      </div>

      <div id="slots" class="slots"></div>
      <div class="disp-hint">
        Tip: tocá un horario para prender/apagar. Si el día está deshabilitado, los horarios quedan bloqueados.
      </div>
    </section>

    <div class="overlay" id="overlay" onclick="if(event.target===this) Admin.closeModal()">
      <div class="modal" role="dialog" aria-modal="true">
        <div class="modal-head">
          <h2 class="modal-title">Detalles del presupuesto</h2>
          <button class="modal-close" onclick="Admin.closeModal()" type="button">✕</button>
        </div>
        <div class="modal-body">
          <div class="grid">
            <div class="kv"><small>Cliente</small><strong id="m_cliente">-</strong></div>
            <div class="kv"><small>Teléfono</small><strong id="m_tel">-</strong></div>
            <div class="kv"><small>Tipo de carga</small><strong id="m_tipo">-</strong></div>

            <div class="kv"><small>Fecha</small><strong id="m_fecha">-</strong></div>
            <div class="kv"><small>Horario</small><strong id="m_hora">-</strong></div>

            <div class="kv"><small>Ayudante</small><strong id="m_ayudante">-</strong></div>
            <div class="kv"><small>Estado</small><strong id="m_estado">-</strong></div>
            <div class="kv"><small>Origen</small><strong id="m_origen">-</strong></div>
            <div class="kv"><small>Destino</small><strong id="m_destino">-</strong></div>
            <div class="kv"><small>Distancia (km)</small><strong id="m_dist_km">-</strong></div>
            <div class="kv"><small>Tiempo de manejo (min)</small><strong id="m_tiempo_viaje">-</strong></div>
            <div class="kv"><small>Tiempo total de servicio (min)</small><strong id="m_tiempo_servicio">-</strong></div>
            <div class="kv"><small>Tiempo carga/descarga (min)</small><strong id="m_tiempo_carga_desc">-</strong></div>
            <div class="kv"><small>Costo tiempo</small><strong id="m_costo_tiempo">-</strong></div>
            <div class="kv"><small>Costo combustible</small><strong id="m_costo_combustible">-</strong></div>
            <div class="kv"><small>Costo ayudante</small><strong id="m_costo_ayudante">-</strong></div>
            <div class="kv total">
              <small><b>Total estimado</b></small>
              <strong id="m_total">$ -</strong>
            </div>
          </div>
        </div>
        <div class="modal-foot">
          <button class="btn-danger" onclick="Admin.eliminar()" type="button">Eliminar</button>
          <div style="display:flex; gap:8px">
            <button class="btn-reject" onclick="Admin.rechazar()" type="button">Rechazar</button>
            <button class="btn-ok" onclick="Admin.aprobar()" type="button">Confirmar</button>
          </div>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>
  </main>

<script>
(function(){
  const byId = (id)=>document.getElementById(id);

  globalThis.API_BASE = globalThis.API_BASE || (
    (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
      ? 'http://127.0.0.1:8000'
      : 'https://fletes-exus.onrender.com'
  );

  const isAdminView = ()=> !!(byId('loginForm') && byId('authFlag') && byId('tbody'));
  const toast = (msg)=>{ const t=byId('toast'); if(!t) return; t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2200); };
  const peso = (n)=> (n!=null ? ('$ ' + Number(n).toLocaleString('es-AR')) : '-');
  const coalesce = (...vals)=>{ for (const v of vals){ if(v!==undefined && v!==null) return v; } return null; };

  // ====== AUTH REAL (API KEY) ======
  // Guardá tu API key en localStorage si querés:
  // localStorage.setItem('ADMIN_API_KEY','TU_KEY')
  const API_KEY = localStorage.getItem("ADMIN_API_KEY") || "AdminFletesJavier20251110!!";
  function adminHeaders(extra = {}) {
    return { "X-API-Key": API_KEY, ...extra };
  }

  const getId = (s) => {
    if (!s) return null;
    if (typeof s.id === "string" || typeof s.id === "number") return String(s.id);
    if (s._id && typeof s._id === "object" && typeof s._id.$oid === "string") return s._id.$oid;
    if (typeof s._id === "string" || typeof s._id === "number") return String(s._id);
    if (typeof s.ID === "string" || typeof s.ID === "number") return String(s.ID);
    return null;
  };

  window.Admin = window.Admin || {};
  let token=null, solicitudes=[], selected=null;

  /* ========= CALENDARIO ========= */
const DOW = ["Lun","Mar","Mié","Jue","Vie","Sáb","Dom"];
let selectedDayKey = null; // YYYY-MM-DD
let calCursor = new Date();   
calCursor.setDate(1);

function iso(d){
  return d.toISOString().slice(0,10);
}

function monthTitle(d){
  return d.toLocaleDateString("es-AR",{month:"long",year:"numeric"});
}

function groupByDay(){
  const map = {};
  solicitudes.forEach(s=>{
    const f = (s.fecha_turno || s.fecha || "").slice(0,10);
    if(!f) return;
    map[f] = map[f] || [];
    map[f].push(s);
  });
  return map;
}

function renderCalendar(){
  const grid = byId("calGrid");
  const title = byId("calTitle");
  if(!grid) return;

  title.textContent = monthTitle(calCursor);
  grid.innerHTML = "";

  DOW.forEach(d=>{
    const e=document.createElement("div");
    e.className="cal-dow";
    e.textContent=d;
    grid.appendChild(e);
  });

  const first = new Date(calCursor.getFullYear(),calCursor.getMonth(),1);
  const last  = new Date(calCursor.getFullYear(),calCursor.getMonth()+1,0);
  const offset = (first.getDay()+6)%7;
  const jobs = groupByDay();

  for(let i=0;i<offset;i++){
    grid.appendChild(document.createElement("div")).className="cal-cell muted";
  }

  for(let d=1;d<=last.getDate();d++){
    const date = new Date(calCursor.getFullYear(),calCursor.getMonth(),d);
    const key = iso(date);
    const has = jobs[key]?.length;

    const c=document.createElement("div");
    c.className="cal-cell";
    const dayClass = has ? "cal-day has" : "cal-day";
    c.innerHTML = `
      <div class="${dayClass}">
        <span class="cal-num">${d}</span>
      </div>
    `;

    c.onclick=()=>selectDay(key);
    grid.appendChild(c);
  }
}
byId("calPrev")?.addEventListener("click", ()=>{
  calCursor = new Date(calCursor.getFullYear(), calCursor.getMonth()-1, 1);
  renderCalendar();
});

byId("calNext")?.addEventListener("click", ()=>{
  calCursor = new Date(calCursor.getFullYear(), calCursor.getMonth()+1, 1);
  renderCalendar();
});


function selectDay(date){
  selectedDayKey = date; 
  const list = groupByDay()[date] || [];
  byId("calDetailTitle").textContent = date;

  if(!list.length){
    byId("calDetailBody").innerHTML="<div class='empty'>No hay fletes hoy.</div>";
    return;
  }

  byId("calDetailBody").innerHTML = list.map((s,i)=>`
    <div class="cal-item">
      <b>${s.nombre_cliente}</b> • ${s.hora_turno || ""}
      <div>${s.origen} → ${s.destino}</div>
      <button class="btn-ghost" onclick="Admin.openModal('${getId(s)}',${i})">
        Detalles
      </button>
    </div>
  `).join("");
}


  /* ========= DISPONIBILIDAD ========= */
  const DEFAULT_SLOTS = [
    "08:00","09:00","10:00","11:00","12:00",
    "13:00","14:00","15:00","16:00","17:00",
    "18:00","19:00","20:00","21:00","22:00"
  ];

  let dispState = {
    byDate: {},      // "YYYY-MM-DD": { enabled:boolean, slots: { "10:00": true } }
    loadedMonth: ""  // "YYYY-MM"
  };

  function ensureDateModel(dateStr){
    if(!dateStr) return null;
    dispState.byDate[dateStr] = dispState.byDate[dateStr] || { enabled:false, slots:{} };
    return dispState.byDate[dateStr];
  }

  function monthOf(dateStr){
    if(!dateStr) return "";
    return dateStr.slice(0,7); // YYYY-MM
  }

  function setDispUIEnabled(dateStr){
    const model = ensureDateModel(dateStr);
    const pill = byId('dispEstado');
    const btn = byId('btnToggleDia');
    const slotsWrap = byId('slots');
    if(!model || !pill || !btn || !slotsWrap) return;

    if(model.enabled){
      pill.classList.remove('off'); pill.classList.add('on');
      pill.textContent = "● Día habilitado";
      btn.textContent = "Deshabilitar día";
      slotsWrap.style.opacity = "1";
      slotsWrap.style.pointerEvents = "auto";
    }else{
      pill.classList.remove('on'); pill.classList.add('off');
      pill.textContent = "● Día deshabilitado";
      btn.textContent = "Habilitar día";
      slotsWrap.style.opacity = ".55";
      slotsWrap.style.pointerEvents = "none";
    }
  }

  function renderSlots(dateStr){
    const model = ensureDateModel(dateStr);
    const wrap = byId('slots');
    if(!wrap || !model) return;
    wrap.innerHTML = "";

    DEFAULT_SLOTS.forEach(h=>{
      const on = !!model.slots[h];
      const b = document.createElement('div');
      b.className = "slot " + (on ? "on" : "off");
      b.textContent = h;
      b.dataset.hour = h;
      b.addEventListener('click', ()=>{
        model.slots[h] = !model.slots[h];
        renderSlots(dateStr);
      });
      wrap.appendChild(b);
    });

    setDispUIEnabled(dateStr);
  }

  // Carga el mes entero desde backend admin
  async function fetchMonthAvailability(month){
    if(!month) return;
    try{
      const res = await fetch(`${API_BASE}/api/admin/availability?month=${encodeURIComponent(month)}`, {
        headers: adminHeaders()
      });
      const data = await res.json();
      if(!res.ok) throw new Error(data.detail || "No se pudo cargar disponibilidad");

      // reset month cache
      dispState.byDate = dispState.byDate || {};
      // volcamos items a byDate
      const items = Array.isArray(data.items) ? data.items : [];
      items.forEach(it=>{
        const d = it.date;
        if(!d) return;
        dispState.byDate[d] = {
          enabled: !!it.enabled,
          slots: (Array.isArray(it.slots) ? it.slots : []).reduce((acc, h)=>{ acc[h]=true; return acc; }, {})
        };
      });

      dispState.loadedMonth = month;
    }catch(e){
      toast(e.message || "Error cargando disponibilidad");
    }
  }

  async function loadDisponibilidad(dateStr){
    if(!dateStr) return;
    const m = monthOf(dateStr);

    if(dispState.loadedMonth !== m){
      await fetchMonthAvailability(m);
    }
    ensureDateModel(dateStr);
    renderSlots(dateStr);
  }

  function toggleDia(dateStr){
    if(!dateStr) return;
    const model = ensureDateModel(dateStr);
    model.enabled = !model.enabled;
    setDispUIEnabled(dateStr);
  }

  function limpiarHorarios(dateStr){
    if(!dateStr) return;
    const model = ensureDateModel(dateStr);
    model.slots = {};
    renderSlots(dateStr);
  }

  async function guardarDisponibilidad(dateStr){
    if(!dateStr) return;
    const model = ensureDateModel(dateStr);

    // { "10:00": true } -> ["10:00"]
    const slotsArr = Object.entries(model.slots)
      .filter(([_, v]) => !!v)
      .map(([h]) => h);

    try{
      const res = await fetch(`${API_BASE}/api/availability/day`, {
        method: "POST",
        headers: adminHeaders({ "Content-Type": "application/json" }),
        body: JSON.stringify({
          date: dateStr,
          enabled: !!model.enabled,
          slots: slotsArr
        })
      });

      const data = await res.json().catch(()=>({}));
      if(!res.ok) throw new Error(data.detail || "Error guardando disponibilidad");

      toast("Disponibilidad guardada ✅");

      // refrescar mes (por si el backend normaliza)
      dispState.loadedMonth = "";
      await loadDisponibilidad(dateStr);
    }catch(e){
      toast(e.message || "Error guardando disponibilidad");
    }
  }

  /* ========= UI AUTH (solo UI) ========= */
  function setAuthUI(isOn){
  const flag = byId('authFlag');
  if (flag){
    flag.textContent = isOn ? 'Autenticado' : 'No autenticado';
    flag.className = 'tag ' + (isOn ? 'ok' : 'muted');
  }

  const btn = byId('btnLogout');
  if (btn){ btn.style.display = isOn ? 'inline-flex' : 'none'; }

  const sw = byId('viewSwitch');
  if (sw) sw.style.display = isOn ? 'flex' : 'none';

  const tabla = byId('tabla');
  if (tabla) tabla.style.display = isOn ? 'table' : 'none';

  const pd = byId('panelDisponibilidad');
  if (pd) pd.style.display = 'none';

  // ✅ NUEVO: ocultar calendario + volver a Solicitudes
  const pc = byId('panelCalendario');
  if (pc) pc.style.display = 'none';

  const tabSol = byId('tabSolicitudes');
  const tabCal = byId('tabCalendario');
  const tabDisp = byId('tabDisponibilidad');
  tabSol?.classList.add('active');
  tabCal?.classList.remove('active');
  tabDisp?.classList.remove('active');
}


  function renderEmpty(msg){
    const tb = byId('tbody'); if(!tb) return;
    tb.innerHTML = `<tr><td colspan="5" class="empty">${msg}</td></tr>`;
  }

  function adminLogout(reason){
    token=null; selected=null;
    if (isAdminView()){
      setAuthUI(false);
      renderEmpty(reason || 'Iniciá sesión para ver las solicitudes de presupuesto.');
      const usr=byId('usr'), pwd=byId('pwd');
      if (usr) usr.value=''; if (pwd) pwd.value='';
      usr?.focus();
    }
  }

  async function login(){
    // Este login ahora es “UI only”, el backend admin se valida por X-API-Key
    if (!isAdminView()) return;
    const usr=byId('usr'), pwd=byId('pwd');
    const username=usr?usr.value.trim():'', password=pwd?pwd.value.trim():'';
    if(!username || !password){ toast('Ingresá usuario y contraseña'); return; }

    token = "ui-session"; // solo flag UI
    setAuthUI(true);
    toast('Sesión iniciada');
    await loadSolicitudes();

    const df = byId('dispFecha');
    if(df && !df.value){
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth()+1).padStart(2,'0');
      const dd = String(today.getDate()).padStart(2,'0');
      df.value = `${yyyy}-${mm}-${dd}`;
    }
    if(byId('dispFecha')?.value) await loadDisponibilidad(byId('dispFecha').value);
  }

  async function loadSolicitudes(){
    if (!isAdminView()) return;
    if (!token){ renderEmpty('Iniciá sesión para ver las solicitudes de presupuesto.'); return; }
    try{
      const res = await fetch(`${API_BASE}/api/requests`, {
        headers: adminHeaders()
      });
      const data = await res.json();
      if(!res.ok) throw new Error(data.detail || 'No se pudieron cargar las solicitudes');
      solicitudes = Array.isArray(data.items) ? data.items : [];
      render();
      if (solicitudes.length===0) renderEmpty('No hay solicitudes.');
    }catch(e){
      renderEmpty(e.message || 'No se pudieron cargar las solicitudes.');
    }
  }

  function render(){
    if (!isAdminView()) return;
    const tb = byId('tbody');
    if (!tb) return;
    tb.innerHTML = '';

    solicitudes.forEach((s, i) => {
      const estado = (s.estado || 'pendiente').toLowerCase();
      const cls = estado === 'confirmado'
        ? 'aprobado'
        : (estado === 'rechazado' ? 'rechazado' : 'pendiente');
      const texto = estado.charAt(0).toUpperCase() + estado.slice(1);
      const rowId = getId(s);

      const tr = document.createElement('tr');
      tr.className = 'row';
      tr.innerHTML = `
        <td>
          <div class="client">
            <span class="name">${s.nombre_cliente || '-'}</span>
            <span class="sub">${s.telefono || '-'}</span>
          </div>
        </td>
        <td>${s.tipo_carga || '-'}</td>
        <td>
          ${ (s.fecha_turno || s.fecha || '-') }
          ${ (s.hora_turno ? ` • ${s.hora_turno}` : '') }
        </td>
        <td><span class="badge ${cls}">${texto}</span></td>
        <td>
          <div class="actions">
            <button class="btn-ghost" type="button"
                    onclick="Admin.openModal('${rowId ?? ''}', ${i})">
              Detalles
            </button>
          </div>
        </td>`;
      tb.appendChild(tr);
    });
  }

  function openModal(id, idx){
    if (!isAdminView()) return;
    if (!token){ adminLogout(); return; }

    let s = null;
    if (id != null) {
      const sid = String(id);
      s = solicitudes.find(x => String(getId(x)) === sid);
    }
    if (!s && Number.isInteger(idx) && idx >= 0 && idx < solicitudes.length) {
      s = solicitudes[idx];
    }
    if (!s) { toast('No se encontró la solicitud'); return; }

    selected = s;

    const tiempo_viaje_min = coalesce(
      s.tiempo_viaje_min,
      (s.tramo_base_origen_min && s.tramo_origen_destino_min)
        ? Number(s.tramo_base_origen_min)+Number(s.tramo_origen_destino_min)+Number(s.tramo_destino_base_min||0)
        : null
    );
    const tiempo_servicio_min   = coalesce(s.tiempo_servicio_min, null);
    const tiempo_carga_desc_min = coalesce(s.tiempo_carga_descarga_min, s.tiempo_servicio_min);
    const costo_tiempo = coalesce(
      s.costo_tiempo,
      (s.costo_tiempo_base!=null && s.mantenimiento!=null)
        ? (Number(s.costo_tiempo_base)+Number(s.mantenimiento))
        : null
    );

    const set = (id,val)=>{ const el=byId(id); if(el) el.textContent=val; };

    set('m_cliente', s.nombre_cliente || '-');
    set('m_tel', s.telefono || '-');
    set('m_tipo', s.tipo_carga || '-');

    set('m_fecha', s.fecha_turno || s.fecha || '-');
    set('m_hora',  s.hora_turno || '-');

    set('m_ayudante', s.ayudante ? 'Sí' : 'No');
    set('m_estado', s.estado || '-');
    set('m_origen', s.origen || '-');
    set('m_destino', s.destino || '-');

    set('m_dist_km', (s.dist_km!=null ? Number(s.dist_km).toFixed(3).replace('.', ',') : '-'));
    set('m_tiempo_viaje', (tiempo_viaje_min!=null ? `${tiempo_viaje_min} min` : '-'));
    set('m_tiempo_servicio', (tiempo_servicio_min!=null ? `${tiempo_servicio_min} min` : '-'));
    set('m_tiempo_carga_desc', (tiempo_carga_desc_min!=null ? `${tiempo_carga_desc_min} min` : '-'));

    set('m_costo_tiempo', peso(costo_tiempo));
    set('m_costo_combustible', peso(s.costo_combustible));
    set('m_costo_ayudante', peso(s.costo_ayudante));
    set('m_total', peso(s.monto_estimado));

    byId('overlay')?.classList.add('open');
  }

  function closeModal(){ byId('overlay')?.classList.remove('open'); selected=null; }

  async function aprobar(){
    if (!selected || !token || !isAdminView()) return;
    try{
      const sid=getId(selected);
      const res=await fetch(`${API_BASE}/api/requests/${sid}/confirm`, {
        method:'POST',
        headers: adminHeaders()
      });
      const data=await res.json();
      if(!res.ok) throw new Error(data.detail || 'No se pudo confirmar');
      toast('Solicitud confirmada ✅'); closeModal(); await loadSolicitudes();
    }catch(e){ toast(e.message || 'Error al confirmar'); }
  }

  async function rechazar(){
    if (!selected || !token || !isAdminView()) return;
    try{
      const sid=getId(selected);
      const res=await fetch(`${API_BASE}/api/requests/${sid}/reject`, {
        method:'POST',
        headers: adminHeaders({ 'Content-Type':'application/json' })
      });
      const data=await res.json();
      if(!res.ok) throw new Error(data.detail || 'No se pudo rechazar');
      toast('Solicitud rechazada'); closeModal(); await loadSolicitudes();
    }catch(e){ toast(e.message || 'Error al rechazar'); }
  }

  async function eliminar(){
    
    if (!selected || !token || !isAdminView()) return;
    if ((selected.estado||'').toLowerCase()!=='rechazado'){ toast('Solo se puede eliminar si está Rechazado'); return; }
    if (!confirm(`¿Eliminar la solicitud de "${selected.nombre_cliente}"? Esta acción no se puede deshacer.`)) return;
    try{
      const sid=getId(selected);
      const res=await fetch(`${API_BASE}/api/requests/${sid}`, {
        method:'DELETE',
        headers: adminHeaders()
      });
      const data=await res.json();
      if(!res.ok) throw new Error(data.detail || 'No se pudo eliminar');
      toast('Solicitud eliminada'); closeModal(); await loadSolicitudes();
      if (typeof renderCalendar === "function") renderCalendar();
      if (selectedDayKey) selectDay(selectedDayKey);
    }catch(e){ toast(e.message || 'Error al eliminar'); }
  }

  window.Admin = window.Admin || {};
  Object.assign(window.Admin, {
    login,
    logout: adminLogout,
    openModal,
    closeModal,
    aprobar,
    rechazar,
    eliminar,
    loadDisponibilidad,
    guardarDisponibilidad,
    toggleDia,
    limpiarHorarios
  });

  (function initAdmin(){
    const NEED=['authFlag','tbody','loginForm'];
    const hasAdmin=()=>NEED.every(id=>document.getElementById(id));
    let inited=false;

    function safeInit(){
      if(inited || !hasAdmin()) return;
      inited=true;

      adminLogout();

      document.getElementById('loginForm')
        ?.addEventListener('submit', (e)=>{ e.preventDefault(); login(); });

      document.addEventListener('visibilitychange',()=>{
        if(document.visibilityState==='visible') adminLogout('Por seguridad, iniciá sesión nuevamente.');
      });
      window.addEventListener('pageshow',(ev)=>{
        if(ev.persisted) adminLogout('Por seguridad, iniciá sesión nuevamente.');
      });

      byId('dispFecha')?.addEventListener('change', (e)=>{
        Admin.loadDisponibilidad(e.target.value);
      });

      byId('btnToggleDia')?.addEventListener('click', ()=>{
        const d = byId('dispFecha')?.value;
        if(!d) return toast("Elegí una fecha");
        Admin.toggleDia(d);
      });

      byId('btnLimpiarDia')?.addEventListener('click', ()=>{
        const d = byId('dispFecha')?.value;
        if(!d) return toast("Elegí una fecha");
        Admin.limpiarHorarios(d);
      });

      byId('btnGuardarDia')?.addEventListener('click', ()=>{
        const d = byId('dispFecha')?.value;
        if(!d) return toast("Elegí una fecha");
        Admin.guardarDisponibilidad(d);
      });
    }

    safeInit();
    requestAnimationFrame(safeInit);
    const mo=new MutationObserver(()=>safeInit());
    mo.observe(document,{childList:true,subtree:true});
    const stop=setInterval(()=>{ if(inited){ mo.disconnect(); clearInterval(stop);} },300);
  })();

  (function initViewSwitch(){
    const tabSol = document.getElementById('tabSolicitudes');
    const tabDisp = document.getElementById('tabDisponibilidad');
    const tabla = document.getElementById('tabla');
    const panelDisp = document.getElementById('panelDisponibilidad');
    const tabCal = document.getElementById('tabCalendario');
    const panelCal = document.getElementById('panelCalendario');

    if (!tabSol || !tabDisp || !tabla || !panelDisp) return;

  const setActive = async (which) => {
  // helpers: prender/apagar tabs
    const setTab = (active) => {
      tabSol?.classList.toggle('active', active === 'sol');
      tabCal?.classList.toggle('active', active === 'cal');
      tabDisp?.classList.toggle('active', active === 'disp');
    };

    // helpers: mostrar/ocultar paneles
    const setPanel = (active) => {
      // Solicitudes usa la tabla (tu UI actual)
      if (tabla) tabla.style.display = (active === 'sol') ? 'table' : 'none';

      // Calendario es un panel aparte
      if (panelCal) panelCal.style.display = (active === 'cal') ? 'block' : 'none';

      // Disponibilidad es tu panel actual
      if (panelDisp) panelDisp.style.display = (active === 'disp') ? 'block' : 'none';
    };

    // 1) Set UI
    setTab(which);
    setPanel(which);

    // 2) Acciones por vista
    if (which === 'cal') {
      // renderCalendar() es la función que te pasé para dibujar el mes
      if (typeof renderCalendar === 'function') renderCalendar();
      return;
    }

    if (which === 'disp') {
      const df = byId('dispFecha');
      if (df && !df.value) {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        df.value = `${yyyy}-${mm}-${dd}`;
      }
      if (df?.value) await Admin.loadDisponibilidad(df.value);
      return;
    }

  // 'sol' -> no hace falta nada extra
};


    tabSol.addEventListener('click', ()=> setActive('sol'));
    tabCal.addEventListener('click', () => setActive('cal'));
    tabDisp.addEventListener('click', ()=> setActive('disp'));
    setActive('sol');
  })();

})();
</script>

  <script defer src="/static/spa.js"></script>
</body>
</html>
