<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fletes Larga Distancia - Admin</title>
  <link rel="icon" type="image/png" href="/images/favicon_fld_white.png">

  <meta http-equiv="Cache-Control" content="no-store" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="referrer" content="no-referrer" />

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/css/admin.css?v=3">
  <link rel="stylesheet" href="/static/css/header.css?v=2">

  <style>
    /* VARIABLES CONFIG PANEL - INJECTED TO BYPASS CACHE */
    .vars-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .vars-group {
      background: #fff;
      border: 1px solid var(--stroke);
      border-radius: 12px;
      padding: 20px;
    }

    .vars-group h3 {
      margin-top: 0;
      margin-bottom: 15px;
      color: var(--accent);
      font-size: 1rem;
      border-bottom: 2px solid #f1f5f9;
      padding-bottom: 8px;
    }

    .vars-group label {
      display: flex !important;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--muted);
    }

    .vars-group input[type="number"] {
      width: 100px !important;
      padding: 6px 10px;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      text-align: right;
      font-weight: 700;
      color: var(--ink);
    }

    .vars-group.full {
      grid-column: 1 / -1;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .chk-row {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #f8fafb;
      padding: 10px;
      border-radius: 8px;
    }

    .chk-row input {
      width: 18px !important;
      height: 18px !important;
      accent-color: var(--primary);
    }

    .chk-row label {
      margin: 0 !important;
      color: var(--ink);
      display: inline-block !important;
    }

    .rule-card {
      transition: all 0.2s ease;
    }

    .rule-card:hover {
      border-color: var(--primary) !important;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      transform: translateY(-2px);
    }

    /* Glass Toggle Switch (seg√∫n imagen) */
    .glass-toggle {
      position: relative;
      display: inline-block;
      width: 72px;
      height: 38px;
      cursor: pointer;
      user-select: none;
    }

    .glass-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .glass-toggle-slider {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(200, 203, 207, 0.4);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border-radius: 40px;
      transition: .4s;
      border: 1.5px solid rgba(255, 255, 255, 0.3);
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 8px;
    }

    .glass-toggle-slider:before {
      position: absolute;
      content: "";
      height: 30px;
      width: 30px;
      left: 4px;
      bottom: 2.5px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      z-index: 2;
    }

    .glass-toggle input:checked+.glass-toggle-slider:before {
      transform: translateX(33px);
    }

    .glass-toggle-icon {
      font-size: 16px;
      z-index: 1;
      opacity: 0.6;
      transition: opacity 0.3s;
    }

    .glass-toggle input:checked+.glass-toggle-slider {
      background: rgba(211, 161, 41, 0.4);
      /* var(--primary) con alpha */
    }

    /* Grisar zona deshabilitada */
    .disabled-zone {
      opacity: 0.45;
      pointer-events: none;
      filter: grayscale(0.8);
      transition: opacity 0.4s, filter 0.4s;
    }

    .rule-container {
      transition: opacity 0.4s;
    }

    .tooltip-hint {
      position: relative;
      cursor: help;
    }

    .tooltip-hint:after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      background: #1e293b;
      color: #fff;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.75rem;
      white-space: nowrap;
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 100;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .tooltip-hint:hover:after {
      visibility: visible;
      opacity: 1;
    }

    /* --- RESPONSIVE MOBILE TABS & FIXES --- */
    .hamburger-btn {
      display: none;
      align-items: center;
      gap: 12px;
      background: #fff;
      border: 2.5px solid var(--stroke);
      padding: 12px 18px;
      border-radius: 14px;
      cursor: pointer;
      width: 100%;
      color: var(--accent);
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
      margin-bottom: 12px;
      outline: none;
    }

    .hamburger-btn:active {
      transform: scale(0.98);
      background: #f8fafb;
    }

    .hamburger-icon {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .hamburger-icon span {
      display: block;
      width: 22px;
      height: 3px;
      background: var(--primary);
      border-radius: 4px;
    }

    .hamburger-text {
      font-weight: 800;
      font-size: 0.9rem;
      letter-spacing: 0.5px;
      font-family: 'Montserrat', sans-serif;
      text-transform: uppercase;
    }

    @media (max-width: 768px) {
      .container {
        padding: 100px 15px 40px !important;
      }

      h1 {
        font-size: 1.6rem;
        line-height: 1.2;
        margin-bottom: 25px;
      }

      .hamburger-btn {
        display: inline-flex;
      }

      .view-switch {
        display: none !important;
        /* Toggle via JS class */
        flex-direction: column !important;
        width: 100% !important;
        gap: 2px !important;
        padding: 8px !important;
        background: #fff !important;
        border: 1.5px solid var(--stroke) !important;
        border-radius: 12px !important;
        margin-bottom: 25px !important;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12) !important;
      }

      .view-switch.open {
        display: flex !important;
      }

      .view-tab {
        width: 100% !important;
        text-align: left !important;
        padding: 14px 18px !important;
        font-size: 0.95rem !important;
        border-radius: 8px !important;
      }

      .view-tab.active {
        background: #f1f5f9 !important;
        color: var(--primary) !important;
      }

      /* Fix de cajas peligrosas y forms */
      .danger-box-resp {
        flex-direction: column !important;
        align-items: stretch !important;
        text-align: center !important;
        gap: 18px !important;
        padding: 24px 18px !important;
      }

      .danger-box-resp button {
        width: 100% !important;
        white-space: normal !important;
        padding: 14px !important;
      }

      .mini-btn {
        padding: 12px 16px !important;
        font-size: 0.95rem !important;
      }

      .top-bar {
        padding: 15px !important;
      }

      /* Form de reglas de bloqueo */
      .rules-form-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 14px;
        align-items: flex-end;
      }

      .rules-form-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .date-range-flex {
        display: flex;
        gap: 10px;
        align-items: flex-end;
      }

      @media (max-width: 550px) {

        .rules-form-grid>div,
        .date-range-flex {
          width: 100% !important;
        }

        .date-range-flex {
          flex-direction: column !important;
          align-items: stretch !important;
        }

        .date-input-full {
          width: 100% !important;
        }
      }
    }
  </style>
</head>

<body data-page="admin">
  <header class="nav">
    <div class="nav-inner">
      <div class="brand">
        <img src="/images/favicon_fld_white.png" alt="FLD Logo">
      </div>

      <div class="nav-links">
        <a href="/" data-view="inicio">Inicio</a>
        <a href="/presupuesto" data-view="presupuesto">Presupuesto</a>
        <a href="/admin" data-view="admin" class="active">Admin</a>

        <!-- ‚úÖ aparece solo logueado -->
        <button id="btnLogout" class="btn-out" type="button" hidden onclick="Admin.logout()">
          Cerrar sesi√≥n
        </button>
      </div>
    </div>
  </header>


  <main class="container">
    <h1>Panel de <span class="accent">Administraci√≥n</span></h1>

    <div id="tabsWrapper" style="display:none">
      <button id="hamburgerTabs" class="hamburger-btn" type="button" onclick="Admin.toggleTabsMenu()">
        <div class="hamburger-icon">
          <span></span>
          <span></span>
          <span></span>
        </div>
        <span class="hamburger-text">Men√∫ de Opciones</span>
      </button>

      <div class="view-switch" id="viewSwitch">
        <button class="view-tab active" id="tabSolicitudes" type="button">Solicitudes</button>
        <button class="view-tab" id="tabCalendario">Calendario</button>
        <button class="view-tab" id="tabDisponibilidad" type="button">Disponibilidad</button>
        <button class="view-tab" id="tabVariables" type="button">Variables</button>
        <button class="view-tab" id="tabCredenciales" type="button">Credenciales</button>
      </div>
    </div>

    <section class="panel" id="panelSolicitudes" style="display:none">
      <div class="requests-tabs" id="reqSwitch" style="display:none">
        <button id="tabReqPend" class="tab-btn active" type="button">Pendientes</button>
        <button id="tabReqHist" class="tab-btn" type="button">Hist√≥ricos</button>
      </div>

      <div class="hist-toolbar" id="histToolbar" style="display:none;">
        <select id="histFilter" class="hist-select">
          <option value="all">Mostrar: Todos</option>
          <option value="completed">Completados</option>
          <option value="voided">Anulados</option>
        </select>

        <div class="hist-search">
          <svg class="hist-search-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
            stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <input type="text" id="histSearch" placeholder="Buscar por cliente, origen..." autocomplete="off">
        </div>
      </div>

      <form id="loginForm" class="login-row" style="display:none" autocomplete="off">
        <input class="input" id="usr" type="text" placeholder="Usuario" autocomplete="username" />
        <input class="input" id="pwd" type="password" placeholder="Contrase√±a" autocomplete="current-password" />
        <button class="btn btn-primary" type="submit">INGRESAR AL PANEL</button>
        <div id="authFlag" class="tag muted">No autenticado</div>
      </form>

      <table class="table" id="tabla" style="display:none">
        <thead class="thead">
          <tr>
            <th>Cliente</th>
            <th>Tipo</th>
            <th>Fecha</th>
            <th>Estado</th>
            <th style="text-align:right">Acciones</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr>
            <td colspan="5" class="empty">Inici√° sesi√≥n para ver las solicitudes de presupuesto.</td>
          </tr>
        </tbody>
      </table>
    </section>

    <!-- ====== PANEL CALENDARIO ====== -->
    <section class="panel" id="panelCalendario" style="display:none">
      <div class="cal-head">
        <button class="mini-btn" id="calPrev" type="button">‚Üê</button>
        <div class="cal-title" id="calTitle">Mes</div>
        <button class="mini-btn" id="calNext" type="button">‚Üí</button>
      </div>

      <div class="cal-grid" id="calGrid"></div>

      <div class="cal-detail" id="calDetail" style="display:none">
        <div class="cal-detail-title" id="calDetailTitle"></div>
        <div class="cal-detail-body" id="calDetailBody"></div>
      </div>
    </section>

    <section class="panel" id="panelDisponibilidad" style="display:none">
      <div class="top-bar">
        <div class="disp-group">
          <input id="dispFecha" type="date" class="date-input" />
          <div id="dispEstado" class="disp-pill off">
            ‚óè D√≠a deshabilitado
          </div>
        </div>

        <div class="disp-actions" style="display:flex; gap:8px;">
          <button id="btnToggleDia" class="mini-btn" type="button">Habilitar d√≠a</button>
          <button id="btnLimpiarDia" class="mini-btn danger" type="button"
            title="Borrar bloqueos manuales del d√≠a seleccionado">Resetear D√≠a</button>
          <button id="btnGuardarDia" class="mini-btn primary" type="button">Guardar cambios</button>
        </div>
      </div>

      <!-- Zona de Reseteo Global -->
      <div class="danger-box-resp"
        style="background: #FFF5F5; border: 1px solid #FECACA; border-radius: 12px; padding: 16px 20px; margin-top: 24px; display: flex; align-items: center; justify-content: space-between; gap: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.02);">
        <div style="flex: 1;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
            <span style="font-size: 1.2rem;">‚ö†Ô∏è</span>
            <strong style="color: #991B1B; font-size: 0.95rem;">Zona Peligrosa: Limpieza Total</strong>
          </div>
          <p style="margin: 0; color: #7F1D1D; font-size: 0.85rem; line-height: 1.5; font-style: normal;">
            Si usaste bloqueos manuales por fuera de las reglas y quer√©s que <strong>todo</strong> el calendario vuelva
            a los horarios est√°ndar (08:00 a 22:00) de forma autom√°tica.
          </p>
        </div>
        <button onclick="Admin.resetearTodo()" class="mini-btn danger"
          style="background: #EF4444; color: white; border: none; padding: 10px 18px; font-weight: 700; border-radius: 8px; cursor: pointer; white-space: nowrap; transition: background 0.2s;">
          Resetear TODO el Calendario
        </button>
      </div>

      <div id="slots" class="slots"></div>
      <div class="disp-hint">
        Tip: toc√° un horario para prender/apagar. Si el d√≠a est√° deshabilitado, los horarios quedan bloqueados.
      </div>

      <!-- ====== REGLAS DE BLOQUEO HORARIO ====== -->
      <div id="blockRulesPanel" style="margin-top:28px; border-top:2px solid #f1f5f9; padding-top:24px;">

        <!-- Encabezado con toggle global -->
        <div
          style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px; margin-bottom:18px;">
          <div>
            <h3 style="margin:0 0 4px; font-size:1.1rem; color: #2F4858; display:flex; align-items:center; gap:8px;">
              <span style="font-size:1.3rem;">üõ°Ô∏è</span> Reglas de bloqueo horario
            </h3>
            <p class="disp-hint" style="margin:0;">Bloque√° autom√°ticamente franjas horarias en m√∫ltiples d√≠as.</p>
          </div>

          <div
            style="display:flex; align-items:center; gap:14px; background: #f1f5f9; padding: 8px 16px; border-radius: 40px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.03);">
            <span id="blockEnabledLabel"
              style="font-size:.85rem; font-weight:700; color: #64748b; min-width: 140px; text-align:right;">‚Äî</span>
            <label class="glass-toggle">
              <input type="checkbox" id="checkToggleBlocks" onchange="Admin.toggleBlockRules()">
              <span class="glass-toggle-slider">
                <span class="glass-toggle-icon" style="margin-left: 2px;">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                    stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                  </svg>
                </span>
                <span class="glass-toggle-icon" style="margin-right: 2px;">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                    stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 9.9-1"></path>
                  </svg>
                </span>
              </span>
            </label>
          </div>
        </div>

        <div id="blockingArea" class="rule-container">
          <!-- Lista de reglas existentes -->
          <div id="blockRulesList" style="margin-bottom:20px;">
            <p class="disp-hint" style="font-style:italic;">Cargando reglas‚Ä¶</p>
          </div>

          <!-- Formulario para agregar nueva regla -->
          <div
            style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:12px; padding:20px; box-shadow: 0 2px 6px rgba(0,0,0,0.02);">
            <p style="margin:0 0 16px; font-size:.9rem; font-weight:700; color:var(--dark);">‚ûï Agregar nueva regla de
              bloqueo</p>

            <div class="rules-form-grid">
              <!-- Hora desde -->
              <div class="rules-form-item">
                <label style="font-size:.78rem; font-weight:600; color:var(--muted);">Desde</label>
                <select id="newBlockFrom" class="date-input date-input-full" style="width:100px;">
                  <option value="07:00">07:00</option>
                  <option value="08:00">08:00</option>
                  <option value="09:00">09:00</option>
                  <option value="10:00">10:00</option>
                  <option value="11:00">11:00</option>
                  <option value="12:00">12:00</option>
                  <option value="13:00">13:00</option>
                  <option value="14:00">14:00</option>
                  <option value="15:00">15:00</option>
                  <option value="16:00">16:00</option>
                  <option value="17:00">17:00</option>
                  <option value="18:00">18:00</option>
                  <option value="19:00">19:00</option>
                  <option value="20:00">20:00</option>
                  <option value="21:00">21:00</option>
                  <option value="22:00">22:00</option>
                </select>
              </div>

              <!-- Hora hasta -->
              <div class="rules-form-item">
                <label style="font-size:.78rem; font-weight:600; color:var(--muted);">Hasta</label>
                <select id="newBlockTo" class="date-input date-input-full" style="width:100px;">
                  <option value="07:00">07:00</option>
                  <option value="08:00">08:00</option>
                  <option value="09:00" selected>09:00</option>
                  <option value="10:00">10:00</option>
                  <option value="11:00">11:00</option>
                  <option value="12:00">12:00</option>
                  <option value="13:00">13:00</option>
                  <option value="14:00">14:00</option>
                  <option value="15:00">15:00</option>
                  <option value="16:00">16:00</option>
                  <option value="17:00">17:00</option>
                  <option value="18:00">18:00</option>
                  <option value="19:00">19:00</option>
                  <option value="20:00">20:00</option>
                  <option value="21:00">21:00</option>
                  <option value="22:00">22:00</option>
                </select>
              </div>

              <!-- Alcance -->
              <div class="rules-form-item">
                <label style="font-size:.78rem; font-weight:600; color:var(--muted);">Aplicar en</label>
                <select id="newBlockMode" class="date-input date-input-full" style="width:190px;"
                  onchange="Admin.onNewBlockModeChange()">
                  <option value="range">Rango de fechas</option>
                  <option value="all">Todos los d√≠as futuros</option>
                </select>
              </div>

              <!-- Fechas (visible solo en modo range) -->
              <div id="newBlockDateRange" class="date-range-flex">
                <div class="rules-form-item">
                  <label style="font-size:.78rem; font-weight:600; color:var(--muted);">Fecha desde</label>
                  <input id="newBlockDateFrom" type="date" class="date-input date-input-full" style="width:145px;" />
                </div>
                <div class="rules-form-item">
                  <label style="font-size:.78rem; font-weight:600; color:var(--muted);">Fecha hasta</label>
                  <input id="newBlockDateTo" type="date" class="date-input date-input-full" style="width:145px;" />
                </div>
              </div>

              <!-- Etiqueta opcional -->
              <div class="rules-form-item">
                <label style="font-size:.78rem; font-weight:600; color:var(--muted);">Etiqueta (opcional)</label>
                <input id="newBlockLabel" type="text" class="date-input date-input-full" placeholder="Ej: Ma√±anas"
                  style="width:140px;" />
              </div>

              <button id="btnAddBlockRule" class="mini-btn primary" type="button" style="height:38px; padding:0 18px;"
                onclick="Admin.agregarReglaBloqueo()">
                Agregar regla
              </button>
            </div>

            <div id="blockAddMsg" style="margin-top:10px; font-size:.82rem;"></div>
          </div>
        </div>
    </section>

    <!-- ====== PANEL VARIABLES (Config) ====== -->
    <section class="panel" id="panelVariables" style="display:none">
      <div class="top-bar">
        <h2>Variables de Presupuesto</h2>
        <button id="btnGuardarVars" class="mini-btn primary" type="button">Guardar cambios</button>
      </div>

      <p class="help">Modific√° los valores base para el c√°lculo autom√°tico.</p>

      <form id="formVars" class="vars-grid">
        <div class="vars-group">
          <h3>Combustible y Veh√≠culo</h3>
          <label>Km por Litro <input type="number" step="0.1" name="KM_POR_LITRO" placeholder="Ej: 8"></label>
          <label>Costo Litro ($) <input type="number" step="1" name="COSTO_LITRO"></label>
          <label>% Mantenimiento <input type="number" step="0.1" name="MANTENIMIENTO_PCT" placeholder="Ej: 20"></label>
        </div>

        <div class="vars-group">
          <h3>Tiempo y Labor</h3>
          <label>Costo Hora (Cliente) <input type="number" step="1" name="COSTO_HORA"></label>
          <label>Costo Hora Ayudante <input type="number" step="1" name="COSTO_HORA_AYUDANTE"></label>
          <label>Costo Hora Chofer (Interno) <input type="number" step="1" name="COSTO_CHOFER_HORA"></label>
          <label>Costo Hora Admin (Interno) <input type="number" step="1" name="COSTO_ADMIN_HORA"></label>
        </div>

        <div class="vars-group">
          <h3>Factores y Ajustes</h3>
          <label>Factor Ponderaci√≥n (Tiempo) <input type="number" step="0.1" name="FACTOR_PONDERACION"
              placeholder="Ej: 1.5"></label>
          <label>Carga/Descarga (h) <input type="number" step="0.1" name="CARGA_DESC_H" placeholder="Ej: 0.5"></label>
          <label>Redondeo Minutos <input type="number" step="1" name="REDONDEO_MIN"></label>
        </div>

        <div class="vars-group">
          <h3>Precios Fijos</h3>
          <label>M√≠nimo Total ($) <input type="number" step="1" name="MIN_TOTAL"></label>
          <label>Costo Peaje ($) <input type="number" step="1" name="COSTO_PEAJE"></label>
        </div>

        <div class="vars-group full">
          <h3>Opciones (S√≠/No)</h3>
          <div class="chk-row"><input type="checkbox" name="RETURN_TO_BASE_DEFAULT"> <label>Retorno a Base
              (Default)</label></div>
          <div class="chk-row"><input type="checkbox" name="INCLUIR_CHOFER_ADMIN_EN_TOTAL"> <label>Incluir Chofer/Admin
              en Total</label></div>
        </div>
      </form>
    </section>

    <!-- ====== PANEL CREDENCIALES ====== -->
    <section class="panel" id="panelCredenciales" style="display:none">
      <div class="card" style="max-width: 600px; margin: 0 auto; padding: 30px;">
        <h2 style="margin-top:0; color: var(--primary);">Seguridad del Acceso</h2>
        <p class="disp-hint" style="margin-bottom: 25px;">Personaliz√° tu usuario y contrase√±a aqu√≠. Record√° que se
          aplicar√°n en tu pr√≥ximo inicio de sesi√≥n.</p>

        <div style="display:flex; flex-direction:column; gap:20px;">
          <div style="display:flex; flex-direction:column; gap:8px;">
            <label style="font-weight:600; color:var(--dark);">Nuevo Usuario / Email</label>
            <input id="newAdminUser" type="text" class="input" placeholder="Ej: admin@ejemplo.com"
              style="background:#f8fafc;" />
          </div>

          <div style="display:flex; flex-direction:column; gap:8px;">
            <label style="font-weight:600; color:var(--dark);">Nueva Contrase√±a</label>
            <input id="newAdminPass" type="password" class="input" placeholder="Nuevos caracteres..."
              style="background:#f8fafc;" />
          </div>

          <div id="credsMsg" style="min-height: 24px; font-weight: 500;"></div>

          <button class="btn btn-primary" type="button" style="width:100%;" onclick="Admin.cambiarCredenciales()">
            GUARDAR NUEVAS CREDENCIALES
          </button>
        </div>
      </div>
    </section>

    <div class="overlay" id="overlay" style="display:none" onclick="if(event.target===this) Admin.closeModal()">
      <div class="modal" role="dialog" aria-modal="true">
        <div class="modal-head">
          <h2 class="modal-title">Detalles del presupuesto</h2>
          <button class="modal-close" onclick="Admin.closeModal()" type="button">‚úï</button>
        </div>
        <div class="modal-body">
          <div class="grid-modal">
            <div class="kv"><small>Cliente</small><strong id="m_cliente">-</strong></div>
            <div class="kv"><small>Tel√©fono</small><strong id="m_tel">-</strong></div>
            <div class="kv"><small>Tipo de carga</small><strong id="m_tipo">-</strong></div>

            <div class="kv"><small>Fecha</small><strong id="m_fecha">-</strong></div>
            <div class="kv"><small>Horario</small><strong id="m_hora">-</strong></div>

            <div class="kv"><small>Ayudante</small><strong id="m_ayudante">-</strong></div>
            <div class="kv"><small>Estado</small><strong id="m_estado">-</strong></div>
            <div class="kv"><small>Origen</small><strong id="m_origen">-</strong></div>
            <div class="kv"><small>Destino</small><strong id="m_destino">-</strong></div>
            <div class="kv"><small>Distancia (km)</small><strong id="m_dist_km">-</strong></div>
            <div class="kv"><small>Tiempo de manejo (min)</small><strong id="m_tiempo_viaje">-</strong></div>
            <div class="kv"><small>Tiempo total de servicio (min)</small><strong id="m_tiempo_servicio">-</strong></div>
            <div class="kv"><small>Tiempo carga/descarga (min)</small><strong id="m_tiempo_carga_desc">-</strong></div>
            <div class="kv"><small>Costo tiempo</small><strong id="m_costo_tiempo">-</strong></div>
            <div class="kv"><small>Costo combustible</small><strong id="m_costo_combustible">-</strong></div>
            <div class="kv"><small>Costo ayudante</small><strong id="m_costo_ayudante">-</strong></div>
            <div class="kv total">
              <small><b>Total estimado</b></small>
              <strong id="m_total">$ -</strong>
            </div>
          </div>
        </div>
        <div class="modal-foot">
          <button class="btn btn-danger" onclick="Admin.eliminar()" type="button">Eliminar</button>
          <div style="display:flex; gap:8px">
            <!-- Acciones Pendientes -->
            <button class="btn btn-reject" onclick="Admin.rechazar()" type="button"
              style="display:none">Rechazar</button>
            <button class="btn btn-ok" onclick="Admin.aprobar()" type="button" style="display:none">Confirmar</button>

            <!-- Acciones Confirmados -->
            <button class="btn btn-out btn-void" onclick="Admin.anular()" type="button"
              style="display:none; color:var(--muted)">Anular</button>
            <button class="btn btn-ok btn-complete" onclick="Admin.completar()" type="button"
              style="display:none">Completar</button>
          </div>

        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>
  </main>

  <script>
    (function () {
      const byId = (id) => document.getElementById(id);

      globalThis.API_BASE = globalThis.API_BASE || (
        (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
          ? 'http://127.0.0.1:8000'
          : ''
      );

      const isAdminView = () => !!(byId('loginForm') && byId('authFlag') && byId('tbody'));
      const toast = (msg) => { const t = byId('toast'); if (!t) return; t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2200); };
      const peso = (n) => (n != null ? ('$ ' + Number(n).toLocaleString('es-AR')) : '-');
      const coalesce = (...vals) => { for (const v of vals) { if (v !== undefined && v !== null) return v; } return null; };

      // ====== AUTH REAL (API KEY) ======
      const API_KEY = localStorage.getItem("ADMIN_API_KEY") || "AdminFletesJavier20251110!!";
      function adminHeaders(extra = {}) {
        return { "X-API-Key": API_KEY, ...extra };
      }

      const getId = (s) => {
        if (!s) return null;
        if (typeof s.id === "string" || typeof s.id === "number") return String(s.id);
        if (s._id && typeof s._id === "object" && typeof s._id.$oid === "string") return s._id.$oid;
        if (typeof s._id === "string" || typeof s._id === "number") return String(s._id);
        if (typeof s.ID === "string" || typeof s.ID === "number") return String(s.ID);
        return null;
      };

      let reqMode = "pending"; // "pending" | "historicos"

      window.Admin = window.Admin || {};
      let token = null, solicitudes = [], calendarSolicitudes = [], selected = null;


      // ====== EXPIRACI√ìN SESI√ìN ADMIN (30 min) ======
      const SESSION_MS = 30 * 60 * 1000;
      const KEY_ON = "ADMIN_SESSION_ON";
      const KEY_EXP = "ADMIN_SESSION_EXPIRES_AT";
      let expTimer = null;

      function setSessionExpiryFromNow() {
        const exp = Date.now() + SESSION_MS;
        sessionStorage.setItem(KEY_ON, "1");
        sessionStorage.setItem(KEY_EXP, String(exp));
        startExpiryTimer();
      }

      function isSessionValid() {
        const on = sessionStorage.getItem(KEY_ON) === "1";
        const exp = Number(sessionStorage.getItem(KEY_EXP) || "0");
        return on && exp && Date.now() < exp;
      }

      function startExpiryTimer() {
        if (expTimer) clearTimeout(expTimer);

        const exp = Number(sessionStorage.getItem(KEY_EXP) || "0");
        const remaining = exp - Date.now();

        if (!exp || remaining <= 0) {
          adminLogout("Sesi√≥n vencida (30 min). Volv√© a iniciar sesi√≥n.");
          return;
        }

        expTimer = setTimeout(() => {
          adminLogout("Sesi√≥n vencida (30 min). Volv√© a iniciar sesi√≥n.");
        }, remaining);
      }


      /* ========= CALENDARIO ========= */
      const DOW = ["Lun", "Mar", "Mi√©", "Jue", "Vie", "S√°b", "Dom"];
      let selectedDayKey = null; // YYYY-MM-DD
      let calCursor = new Date();
      calCursor.setDate(1);

      function iso(d) { return d.toISOString().slice(0, 10); }
      function monthTitle(d) { return d.toLocaleDateString("es-AR", { month: "long", year: "numeric" }); }

      function groupByDay() {
        const map = {};
        (calendarSolicitudes || []).forEach(s => {
          const f = (s.fecha_turno || s.fecha || "").slice(0, 10);
          if (!f) return;
          map[f] = map[f] || [];
          map[f].push(s);
        });
        return map;
      }



      function renderCalendar() {
        const grid = byId("calGrid");
        const title = byId("calTitle");
        if (!grid) return;

        title.textContent = monthTitle(calCursor);
        grid.innerHTML = "";

        DOW.forEach(d => {
          const e = document.createElement("div");
          e.className = "cal-dow";
          e.textContent = d;
          grid.appendChild(e);
        });

        const first = new Date(calCursor.getFullYear(), calCursor.getMonth(), 1);
        const last = new Date(calCursor.getFullYear(), calCursor.getMonth() + 1, 0);
        const offset = (first.getDay() + 6) % 7;
        const jobs = groupByDay();

        for (let i = 0; i < offset; i++) {
          grid.appendChild(document.createElement("div")).className = "cal-cell muted";
        }

        for (let d = 1; d <= last.getDate(); d++) {
          const date = new Date(calCursor.getFullYear(), calCursor.getMonth(), d);
          const key = iso(date);

          const has = (jobs[key] && jobs[key].length > 0); // ‚úÖ boolean real

          const c = document.createElement("div");
          c.className = "cal-cell";

          // ‚úÖ AC√Å se pinta el d√≠a (la celda)
          if (has) c.classList.add("has-flete");

          c.innerHTML = `
        <div class="cal-day">
          <span class="cal-num">${d}</span>
        </div>
      `;

          c.onclick = () => selectDay(key);
          grid.appendChild(c);
        }

      }

      function renderSolicitudMini(q) {
        return `
    <div class="req-mini">
      <div class="req-mini-top">
        <div class="req-mini-name">${escapeHtml(q.nombre_cliente)}</div>
        <span class="badge ${badgeClass(q.estado)}">${q.estado}</span>
      </div>

      <div class="req-mini-sub">
        ${q.fecha_turno || q.fecha} ‚Ä¢ ${q.hora_turno || ""}
      </div>

      <button class="btn btn-ghost" data-id="${q.id}">Detalles</button>
    </div>
  `;
      }


      byId("calPrev")?.addEventListener("click", () => {
        calCursor = new Date(calCursor.getFullYear(), calCursor.getMonth() - 1, 1);
        renderCalendar();
      });

      byId("calNext")?.addEventListener("click", () => {
        calCursor = new Date(calCursor.getFullYear(), calCursor.getMonth() + 1, 1);
        renderCalendar();
      });

      function selectDay(date) {
        selectedDayKey = date;
        const list = groupByDay()[date] || [];

        const detailWrap = byId("calDetail");
        if (detailWrap) detailWrap.style.display = "block";

        // Formatear fecha para el t√≠tulo (ej: 27 de Enero)
        const dObj = new Date(date + "T12:00:00");
        const fText = dObj.toLocaleDateString("es-AR", { day: 'numeric', month: 'long' });

        byId("calDetailTitle").innerHTML = `<span>D√≠a seleccionado:</span> <strong>${fText}</strong>`;

        if (!list.length) {
          byId("calDetailBody").innerHTML = "<div class='empty'>No hay fletes programados para este d√≠a.</div>";
          return;
        }

        byId("calDetailBody").innerHTML = list.map((s, i) => `
    <div class="cal-card">
      <div class="cal-card-top">
        <div class="cal-card-date">${date}</div>
        <div class="cal-card-time"><i class="far fa-clock"></i> ${s.hora_turno || "Sin hora"}</div>
      </div>

      <div class="cal-card-title">${s.nombre_cliente || "Cliente sin nombre"}</div>
      <div class="cal-card-route">
        <div style="margin-bottom:4px"><b>Desde:</b> ${s.origen || "-"}</div>
        <div><b>Hacia:</b> ${s.destino || "-"}</div>
      </div>

      <div class="cal-card-actions">
        <button class="btn btn-ghost" onclick="Admin.openModal('${getId(s)}',${i})">
          Ver detalles completo
        </button>
      </div>
    </div>
  `).join("");
      }

      /* ========= DISPONIBILIDAD ========= */
      const DEFAULT_SLOTS = [
        "08:00", "09:00", "10:00", "11:00", "12:00",
        "13:00", "14:00", "15:00", "16:00", "17:00",
        "18:00", "19:00", "20:00", "21:00", "22:00"
      ];

      let dispState = {
        byDate: {},      // "YYYY-MM-DD": { enabled:boolean, slots: { "10:00": true } }
        loadedMonth: "",  // "YYYY-MM"
        lockedByDate: {} // "YYYY-MM-DD": Set( "10:00", "11:00" )
      };

      function ensureDateModel(dateStr) {
        if (!dateStr) return null;
        // ENABLED by default
        dispState.byDate[dateStr] = dispState.byDate[dateStr] || { enabled: true, slots: {} };
        return dispState.byDate[dateStr];
      }

      function monthOf(dateStr) {
        if (!dateStr) return "";
        return dateStr.slice(0, 7); // YYYY-MM
      }

      function setDispUIEnabled(dateStr) {
        const model = ensureDateModel(dateStr);
        const pill = byId('dispEstado');
        const btn = byId('btnToggleDia');
        const slotsWrap = byId('slots');
        if (!model || !pill || !btn || !slotsWrap) return;

        if (model.enabled) {
          pill.classList.remove('off'); pill.classList.add('on');
          pill.textContent = "‚óè D√≠a habilitado";
          btn.textContent = "Deshabilitar d√≠a";
          slotsWrap.style.opacity = "1";
          slotsWrap.style.pointerEvents = "auto";
        } else {
          pill.classList.remove('on'); pill.classList.add('off');
          pill.textContent = "‚óè D√≠a deshabilitado";
          btn.textContent = "Habilitar d√≠a";
          slotsWrap.style.opacity = ".55";
          slotsWrap.style.pointerEvents = "none";
        }
      }

      function renderSlots(dateStr) {
        const model = ensureDateModel(dateStr);
        const wrap = byId('slots');
        if (!wrap || !model) return;
        wrap.innerHTML = "";

        const locked = dispState.lockedByDate?.[dateStr] || new Set();

        DEFAULT_SLOTS.forEach(h => {
          const isLocked = locked.has(h);
          const on = true; // Por defecto ON en la vista admin para que se vean todos verdes y habilitados por defecto.

          const b = document.createElement('div');
          b.className = "slot " + (model.slots[h] === false ? "off" : "on") + (isLocked ? " locked" : "");
          b.textContent = h;
          b.dataset.hour = h;

          b.addEventListener('click', () => {
            if (isLocked) {
              toast("Ese horario ya est√° en uso (reservado/confirmado).");
              return;
            }
            // Si es undefined (default), pasamos a false (off). Si es false, a true (on).
            model.slots[h] = (model.slots[h] === false) ? true : false;
            renderSlots(dateStr);
          });

          wrap.appendChild(b);
        });

        setDispUIEnabled(dateStr);
      }


      async function fetchMonthAvailability(month) {
        if (!month) return;
        try {
          const res = await fetch(`${API_BASE}/api/admin/availability?month=${encodeURIComponent(month)}`, {
            headers: adminHeaders()
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.detail || "No se pudo cargar disponibilidad");

          dispState.byDate = dispState.byDate || {};
          const items = Array.isArray(data.items) ? data.items : [];
          items.forEach(it => {
            const d = it.date;
            if (!d) return;
            dispState.byDate[d] = {
              enabled: (it.enabled !== undefined) ? !!it.enabled : true,
              slots: (Array.isArray(it.slots) ? it.slots : []).reduce((acc, h) => { acc[h] = true; return acc; }, {})
            };
          });

          dispState.loadedMonth = month;
        } catch (e) {
          toast(e.message || "Error cargando disponibilidad");
        }
      }

      async function loadDisponibilidad(dateStr) {
        if (!dateStr) return;
        const m = monthOf(dateStr);

        if (dispState.loadedMonth !== m) {
          await fetchMonthAvailability(m);
          dispState.lockedByDate = {}; // ‚úÖ opcional: reset por cambio de mes
        }

        // ‚úÖ traer ocupados del d√≠a
        await fetchLockedSlots(dateStr);

        ensureDateModel(dateStr);
        renderSlots(dateStr);
      }
      async function loadCalendarConfirmed() {
        try {
          const res = await fetch(`${API_BASE}/api/requests?status=all`, {
            headers: adminHeaders()
          });

          const ct = res.headers.get("content-type") || "";
          if (!ct.includes("application/json")) {
            throw new Error("La API devolvi√≥ HTML (ruta incorrecta o backend no respondi√≥ JSON).");
          }

          const data = await res.json();
          if (!res.ok) throw new Error(data.detail || "No se pudo cargar solicitudes");

          calendarSolicitudes = (data.items || []).filter(
            s => String(s.estado || '').toLowerCase() === 'confirmado'
          );

        } catch (e) {
          calendarSolicitudes = [];
          toast(e.message || "Error cargando confirmados");
        }
      }





      function toggleDia(dateStr) {
        if (!dateStr) return;
        const model = ensureDateModel(dateStr);
        model.enabled = !model.enabled;
        setDispUIEnabled(dateStr);
      }

      async function limpiarHorarios(dateStr) {
        if (!dateStr) return;
        if (!confirm(`¬øResetear disponibilidad para el ${dateStr}? Se borrar√°n los bloqueos manuales y volver√° al horario est√°ndar.`)) return;

        try {
          const res = await fetch(`${API_BASE}/api/availability/day/${dateStr}`, {
            method: 'DELETE', headers: adminHeaders()
          });
          if (!res.ok) throw new Error("Error al resetear");
          toast("D√≠a reseteado a valores default ‚úÖ");

          // Forzar recarga total de ese mes para ver los DEFAULT_SLOTS
          dispState.loadedMonth = "";
          await loadDisponibilidad(dateStr);
        } catch (e) {
          toast(e.message || "Error al resetear");
        }
      }

      async function guardarDisponibilidad(dateStr) {
        if (!dateStr) return;
        const model = ensureDateModel(dateStr);

        // Si no hay slots configurados (est√° vac√≠o), asumimos que todos los DEFAULT_SLOTS est√°n activos (on)
        // a menos que el d√≠a est√© deshabilitado.
        let slotsArr = [];
        if (model.enabled) {
          slotsArr = DEFAULT_SLOTS.filter(h => model.slots[h] !== false);
        }

        try {
          const res = await fetch(`${API_BASE}/api/availability/day`, {
            method: "POST",
            headers: adminHeaders({ "Content-Type": "application/json" }),
            body: JSON.stringify({ date: dateStr, enabled: !!model.enabled, slots: slotsArr })
          });

          const ct = res.headers.get("content-type") || "";

          // ‚úÖ si vuelve HTML, mostralo y cort√°
          if (!ct.includes("application/json")) {
            const txt = await res.text();
            throw new Error("La API devolvi√≥ HTML (ruta incorrecta o catch-all del SPA).");
          }

          const data = await res.json();
          if (!res.ok) throw new Error(data.detail || "Error guardando disponibilidad");

          toast("Disponibilidad guardada ‚úÖ");
          dispState.loadedMonth = "";
          await loadDisponibilidad(dateStr);

        } catch (e) {
          toast(e.message || "Error guardando disponibilidad");
        }
      }

      /* =================== VARIABLES LOGIC =================== */
      async function loadVariables() {
        if (!isAdminView()) return;
        try {
          const res = await fetch(`${API_BASE}/api/admin/config-vars`, { headers: adminHeaders() });
          if (!res.ok) throw new Error("Error cargando variables");
          const data = await res.json();

          const form = byId('formVars');
          if (!form) return;

          form.reset();
          Object.keys(data).forEach(key => {
            const input = form.elements[key];
            if (input) {
              if (input.type === 'checkbox') {
                input.checked = !!data[key];
              } else {
                input.value = data[key];
              }
            }
          });
        } catch (e) {
          toast(e.message || "Error al cargar configuraci√≥n");
        }
      }

      async function guardarVariables() {
        if (!isAdminView()) return;
        const form = byId('formVars');
        if (!form) return;

        const payload = {};
        Array.from(form.elements).forEach(el => {
          if (!el.name) return;
          if (el.type === 'checkbox') {
            payload[el.name] = el.checked;
          } else if (el.type === 'number') {
            payload[el.name] = el.value === "" ? null : Number(el.value);
          } else {
            payload[el.name] = el.value;
          }
        });

        try {
          const res = await fetch(`${API_BASE}/api/admin/config-vars`, {
            method: 'POST',
            headers: adminHeaders({ 'Content-Type': 'application/json' }),
            body: JSON.stringify(payload)
          });
          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || "Error al guardar");
          }
          toast("Variables guardadas correctamente ‚úÖ");
        } catch (e) {
          toast(e.message || "Error al guardar");
        }
      }
      async function fetchLockedSlots(dateStr) {
        try {
          const res = await fetch(`${API_BASE}/api/admin/bookings/day?date=${encodeURIComponent(dateStr)}`, {
            headers: adminHeaders()
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.detail || "No se pudo cargar ocupados");
          dispState.lockedByDate[dateStr] = new Set((data.ocupados || []));
        } catch (e) {
          dispState.lockedByDate[dateStr] = new Set();
        }
      }





      /* ========= UI AUTH (solo UI) ========= */
      function setAuthUI(isOn) {
        const loginForm = byId('loginForm');
        const btnLogout = byId('btnLogout');
        const flag = byId('authFlag');
        const tabla = byId('tabla');
        const thead = document.querySelector('.thead');
        const viewSwitch = byId('viewSwitch');
        const reqSwitch = byId('reqSwitch');

        if (loginForm) loginForm.style.display = isOn ? 'none' : 'flex';
        if (btnLogout) {
          btnLogout.hidden = !isOn;          // ‚úÖ muestra/oculta de verdad
        }


        if (flag) {
          flag.textContent = isOn ? 'Autenticado' : 'No autenticado';
          flag.className = 'tag ' + (isOn ? 'ok' : 'muted');
        }

        const pSol = byId('panelSolicitudes');
        const pDisp = byId('panelDisponibilidad');
        const pCal = byId('panelCalendario');
        const pVars = byId('panelVariables');
        const tabsWrapper = byId('tabsWrapper');
        const pCreds = byId('panelCredenciales');

        if (tabsWrapper) tabsWrapper.style.display = isOn ? 'block' : 'none';
        if (tabla) tabla.style.display = 'table'; // Siempre visible para mostrar el mensaje de "Inici√° sesi√≥n"
        if (thead) thead.style.display = isOn ? 'table-header-group' : 'none';
        if (reqSwitch) reqSwitch.style.display = isOn ? 'flex' : 'none';

        // Asegurar que el panel principal se vea (contiene login o tabla)
        if (pSol) pSol.style.display = 'block';

        if (pDisp) pDisp.style.display = 'none';
        if (pCal) pCal.style.display = 'none';
        if (pVars) pVars.style.display = 'none';
        if (pCreds) pCreds.style.display = 'none';

        byId('tabSolicitudes')?.classList.add('active');
        byId('tabCalendario')?.classList.remove('active');
        byId('tabDisponibilidad')?.classList.remove('active');
        byId('tabVariables')?.classList.remove('active');
        byId('tabCredenciales')?.classList.remove('active');
      }

      function renderEmpty(msg) {
        const tb = byId('tbody'); if (!tb) return;
        tb.innerHTML = `<tr><td colspan="5" class="empty">${msg}</td></tr>`;
      }

      function adminLogout(reason) {

        if (expTimer) clearTimeout(expTimer);
        sessionStorage.removeItem(KEY_EXP);
        sessionStorage.removeItem(KEY_ON); // ya lo hac√≠as, pero dejalo as√≠ prolijo

        token = null;
        selected = null;
        solicitudes = [];

        if (!isAdminView()) return;

        setAuthUI(false);
        renderEmpty(reason || 'Inici√° sesi√≥n para ver las solicitudes de presupuesto.');

        const usr = byId('usr'), pwd = byId('pwd');
        if (usr) usr.value = '';
        if (pwd) pwd.value = '';
        usr?.focus();
      }

      async function login() {
        if (!isAdminView()) return;

        const usr = byId('usr'), pwd = byId('pwd');
        const username = usr ? usr.value.trim() : '', password = pwd ? pwd.value.trim() : '';
        if (!username || !password) { toast('Ingres√° usuario y contrase√±a'); return; }

        try {
          const res = await fetch(`${API_BASE}/api/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email: username, password })
          });

          const data = await res.json().catch(() => ({}));
          if (!res.ok || !data.ok) {
            throw new Error(data.detail || data.message || "Credenciales inv√°lidas");
          }

          // ‚úÖ si login OK (aunque tu seguridad real siga siendo X-API-Key)
          token = "ui-session";
          setSessionExpiryFromNow(); // ‚úÖ guarda ON + EXPIRES y arranca el timer


          setAuthUI(true);
          toast("Sesi√≥n iniciada");
          await loadSolicitudes();

        } catch (e) {
          adminLogout(e.message || "No se pudo iniciar sesi√≥n");
        }
      }


      async function loadSolicitudes(mode = reqMode) {
        if (!isAdminView()) return;
        if (!token) { renderEmpty('Inici√° sesi√≥n para ver las solicitudes de presupuesto.'); return; }

        reqMode = mode;

        // ‚úÖ lo que pide el backend
        const apiStatus = (reqMode === "historicos") ? "historicos" : "pending";

        try {
          const url = `${API_BASE}/api/requests?status=${encodeURIComponent(apiStatus)}`;
          const res = await fetch(url, { headers: adminHeaders() });

          const ct = res.headers.get("content-type") || "";
          if (!ct.includes("application/json")) throw new Error("La API devolvi√≥ HTML.");

          const data = await res.json();
          if (!res.ok) throw new Error(data.detail || 'No se pudieron cargar las solicitudes');

          solicitudes = Array.isArray(data.items) ? data.items : [];

          // ‚úÖ Si estamos en hist√≥ricos, aplicar filtros de la UI si existen
          if (reqMode === "historicos") {
            const hFilter = document.getElementById('histFilter');
            const hSearch = document.getElementById('histSearch');

            const type = hFilter?.value || "all";
            const term = (hSearch?.value || "").toLowerCase();

            if (type !== "all" || term) {
              solicitudes = solicitudes.filter(x => {
                const st = String(x.estado || '').toLowerCase();
                const matchType = (type === "all") ||
                  (type === "completed" && st === "realizado") ||
                  (type === "voided" && st === "anulado");
                const matchTerm = !term ||
                  (x.nombre_cliente || "").toLowerCase().includes(term) ||
                  (x.origen || "").toLowerCase().includes(term) ||
                  (x.destino || "").toLowerCase().includes(term);
                return matchType && matchTerm;
              });
            }
          }

          render();

          if (solicitudes.length === 0) {
            renderEmpty(reqMode === "historicos" ? "No hay hist√≥ricos que coincidan." : "No hay pendientes.");
          }

        } catch (e) {
          renderEmpty(e.message || 'No se pudieron cargar las solicitudes.');
        }
      }




      function render() {
        if (!isAdminView()) return;
        const tb = byId('tbody');
        if (!tb) return;
        tb.innerHTML = '';

        solicitudes.forEach((s, i) => {
          const estado = (s.estado || 'pendiente').toLowerCase();
          const cls = estado === 'confirmado'
            ? 'aprobado'
            : (estado === 'rechazado' ? 'rechazado' : (estado === 'historico' ? 'rechazado' : 'pendiente'));
          const texto = estado.charAt(0).toUpperCase() + estado.slice(1);
          const rowId = getId(s);

          const tr = document.createElement('tr');
          tr.className = 'row';
          tr.innerHTML = `
        <td data-label="Cliente">
          <div class="client">
            <span class="name">${s.nombre_cliente || '-'}</span>
            <span class="sub">${s.telefono || '-'}</span>
          </div>
        </td>
        <td data-label="Carga">${s.tipo_carga || '-'}</td>
        <td data-label="Fecha/Hora">
          ${(s.fecha_turno || s.fecha || '-')}
          ${(s.hora_turno ? ` ‚Ä¢ ${s.hora_turno}` : '')}
        </td>
        <td data-label="Estado"><span class="badge ${cls}">${texto}</span></td>
        <td data-label="Acciones">
          <div class="actions">
            <button class="btn btn-ghost" type="button"
                    onclick="Admin.openModal('${rowId ?? ''}', ${i})">
              Detalles
            </button>
          </div>
        </td>`;
          tb.appendChild(tr);
        });
      }

      function openModal(id, idx) {
        if (!isAdminView()) return;
        if (!token) { adminLogout(); return; }

        let s = null;
        if (id != null) {
          const sid = String(id);
          // Buscar en tabla principal O en calendario
          s = (solicitudes || []).find(x => String(getId(x)) === sid);
          if (!s) {
            s = (calendarSolicitudes || []).find(x => String(getId(x)) === sid);
          }
        }
        if (!s && Number.isInteger(idx) && idx >= 0 && idx < (solicitudes || []).length) {
          s = solicitudes[idx];
        }
        if (!s) { toast('No se encontr√≥ la solicitud'); return; }

        selected = s;

        // üîí BLOQUEO SOLO EN HIST√ìRICOS + REALIZADO
        const estado = String(s.estado || "").toLowerCase();
        const isHistoricosView = (reqMode === "historicos");
        const lockActions = isHistoricosView && (estado === "realizado");

        const modal = byId('overlay');
        const btnConfirm = document.querySelector(".btn-ok");
        const btnReject = document.querySelector(".btn-reject");

        if (btnConfirm) btnConfirm.style.display = lockActions ? "none" : "inline-flex";
        if (btnReject) btnReject.style.display = lockActions ? "none" : "inline-flex";

        // --- tu c√≥digo existente de setear datos ---
        const tiempo_viaje_min = coalesce(
          s.tiempo_viaje_min,
          (s.tramo_base_origen_min && s.tramo_origen_destino_min)
            ? Number(s.tramo_base_origen_min) + Number(s.tramo_origen_destino_min) + Number(s.tramo_destino_base_min || 0)
            : null
        );
        const tiempo_servicio_min = coalesce(s.tiempo_servicio_min, null);
        const tiempo_carga_desc_min = coalesce(s.tiempo_carga_descarga_min, s.tiempo_servicio_min);
        const costo_tiempo = coalesce(
          s.costo_tiempo,
          (s.costo_tiempo_base != null && s.mantenimiento != null)
            ? (Number(s.costo_tiempo_base) + Number(s.mantenimiento))
            : null
        );

        const set = (id, val) => { const el = byId(id); if (el) el.textContent = val; };

        set('m_cliente', s.nombre_cliente || '-');
        set('m_tel', s.telefono || '-');
        set('m_tipo', s.tipo_carga || '-');

        set('m_fecha', s.fecha_turno || s.fecha || '-');
        set('m_hora', s.hora_turno || '-');

        set('m_ayudante', s.ayudante ? 'S√≠' : 'No');
        set('m_estado', s.estado || '-');
        set('m_origen', s.origen || '-');
        set('m_destino', s.destino || '-');

        set('m_dist_km', (s.dist_km != null ? Number(s.dist_km).toFixed(3).replace('.', ',') : '-'));
        set('m_tiempo_viaje', (tiempo_viaje_min != null ? `${tiempo_viaje_min} min` : '-'));
        set('m_tiempo_servicio', (tiempo_servicio_min != null ? `${tiempo_servicio_min} min` : '-'));
        set('m_tiempo_carga_desc', (tiempo_carga_desc_min != null ? `${tiempo_carga_desc_min} min` : '-'));

        set('m_costo_tiempo', peso(costo_tiempo));
        set('m_costo_combustible', peso(s.costo_combustible));
        set('m_costo_ayudante', peso(s.costo_ayudante));
        set('m_total', peso(s.monto_estimado));

        byId('overlay')?.classList.add('open');
      }


      function closeModal() { byId('overlay')?.classList.remove('open'); selected = null; }


      async function aprobar() {
        if (reqMode === "historicos" && String(selected?.estado || "").toLowerCase() === "realizado") {
          toast("Este flete ya est√° realizado. Solo se puede eliminar.");
          return;
        }
        if (!selected || !token || !isAdminView()) return;
        try {
          const sid = getId(selected);
          const res = await fetch(`${API_BASE}/api/requests/${sid}/confirm`, {
            method: 'POST',
            headers: adminHeaders()
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.detail || 'No se pudo confirmar');
          toast('Solicitud confirmada ‚úÖ'); closeModal(); await loadSolicitudes();
        } catch (e) { toast(e.message || 'Error al confirmar'); }
      }

      async function rechazar() {
        if (reqMode === "historicos" && String(selected?.estado || "").toLowerCase() === "realizado") {
          toast("Este flete ya est√° realizado. Solo se puede eliminar.");
          return;
        }
        if (!selected || !token || !isAdminView()) return;
        try {
          const sid = getId(selected);
          const res = await fetch(`${API_BASE}/api/requests/${sid}/reject`, {
            method: 'POST',
            headers: adminHeaders({ 'Content-Type': 'application/json' })
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.detail || 'No se pudo rechazar');
          toast('Solicitud rechazada'); closeModal(); await loadSolicitudes();
        } catch (e) { toast(e.message || 'Error al rechazar'); }
      }

      async function eliminar() {
        if (!selected || !token || !isAdminView()) return;
        if (!confirm(`¬øEliminar la solicitud de "${selected.nombre_cliente}"? Esta acci√≥n no se puede deshacer.`)) return;
        try {
          const sid = getId(selected);
          const res = await fetch(`${API_BASE}/api/requests/${sid}`, {
            method: 'DELETE',
            headers: adminHeaders()
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.detail || 'No se pudo eliminar');
          toast('Solicitud eliminada'); closeModal(); await loadSolicitudes();
          if (typeof renderCalendar === "function") renderCalendar();
          if (selectedDayKey) selectDay(selectedDayKey);
        } catch (e) { toast(e.message || 'Error al eliminar'); }
      }

      /* =================== NUEVAS FUNCIONES COMPLETAR / ANULAR =================== */
      async function completar() {
        if (!selected || !token || !isAdminView()) return;
        if (!confirm(`¬øMarcar este trabajo como COMPLETADO? Se mover√° a hist√≥ricos.`)) return;
        try {
          const sid = getId(selected);
          await fetch(`${API_BASE}/api/requests/${sid}/complete`, { method: 'POST', headers: adminHeaders() });
          toast('Trabajo completado exitosamente üöÄ');
          closeModal();

          if (byId('tabCalendario')?.classList.contains('active')) {
            await loadCalendarConfirmed();
            renderCalendar();
            byId("calDetailBody").innerHTML = "<div class='empty'>Seleccion√° un d√≠a para ver detalles.</div>";
            byId("calDetailTitle").innerHTML = "";
          } else {
            await loadSolicitudes();
          }

        } catch (e) { toast(e.message || 'Error al completar'); }
      }

      async function anular() {
        if (!selected || !token || !isAdminView()) return;
        if (!confirm(`¬øANULAR este trabajo? El horario quedar√° libre.`)) return;
        try {
          const sid = getId(selected);
          await fetch(`${API_BASE}/api/requests/${sid}/void`, { method: 'POST', headers: adminHeaders() });
          toast('Trabajo anulado');
          closeModal();

          if (byId('tabCalendario')?.classList.contains('active')) {
            await loadCalendarConfirmed();
            renderCalendar();
            byId("calDetailBody").innerHTML = "<div class='empty'>Seleccion√° un d√≠a para ver detalles.</div>";
            byId("calDetailTitle").innerHTML = "";
          } else {
            await loadSolicitudes();
          }

        } catch (e) { toast(e.message || 'Error al anular'); }
      }

      function escapeHtml(text) {
        if (!text) return "";
        const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
        return text.replace(/[&<>"']/g, m => map[m]);
      }

      // =================== REGLAS DE BLOQUEO HORARIO ===================

      async function loadBlockRules() {
        try {
          const res = await fetch(`${API_BASE}/api/admin/block-rules`, { headers: adminHeaders() });
          const data = await res.json();
          if (!res.ok) throw new Error(data.detail || 'Error cargando reglas');
          renderBlockRules(data.blocks_enabled, data.rules || []);
        } catch (e) {
          const list = byId('blockRulesList');
          if (list) list.innerHTML = `<p class="disp-hint" style="color:#e74c3c;">‚ö†Ô∏è ${e.message}</p>`;
        }
      }

      function renderBlockRules(blocksEnabled, rules) {
        // Actualizar toggle glass
        const label = byId('blockEnabledLabel');
        const check = byId('checkToggleBlocks');
        const area = byId('blockingArea');

        if (label) {
          label.textContent = blocksEnabled ? 'Bloqueos ACTIVOS' : 'Bloqueos INACTIVOS';
          label.style.color = blocksEnabled ? '#27ae60' : '#e74c3c';
        }
        if (check) {
          check.checked = blocksEnabled;
        }
        if (area) {
          area.classList.toggle('disabled-zone', !blocksEnabled);
        }

        // Renderizar lista de reglas
        const list = byId('blockRulesList');
        if (!list) return;

        if (!rules.length) {
          list.innerHTML = `<p class="disp-hint" style="font-style:italic; color:var(--muted);">Sin reglas configuradas. Agreg√° una abajo.</p>`;
          return;
        }

        list.innerHTML = rules.map(r => {
          const scope = r.apply_all
            ? 'üìÖ Todos los d√≠as futuros'
            : `üìÖ ${r.date_from || '?'} ‚Üí ${r.date_to || '?'}`;
          const rangeText = `üïê ${r.hour_from} ‚Äì ${r.hour_to}`;
          const labelTxt = r.label ? ` ¬∑ <em>${escapeHtml(r.label)}</em>` : '';
          const disabledNote = !blocksEnabled ? ' <span style="opacity:.5;">(inactiva)</span>' : '';
          return `
            <div class="rule-card" style="display:flex; align-items:center; justify-content:space-between; gap:12px;
              background:#fff; border:1px solid #e2e8f0; border-radius:8px; padding:10px 14px; margin-bottom:8px;">
              <div style="font-size:.88rem; line-height:1.5;">
                <strong>${rangeText}</strong>${labelTxt}${disabledNote}<br>
                <span style="color:var(--muted); font-size:.8rem;">${scope}</span>
              </div>
              <button class="mini-btn danger" style="padding:4px 12px; font-size:.8rem; flex-shrink:0;"
                onclick="Admin.eliminarReglaBloqueo('${r.id}')">Eliminar</button>
            </div>`;
        }).join('');
      }

      async function toggleBlockRules() {
        const btn = byId('btnToggleBlocks');
        if (btn) { btn.disabled = true; }
        try {
          const res = await fetch(`${API_BASE}/api/admin/block-rules/toggle`, {
            method: 'POST', headers: adminHeaders()
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.detail || 'Error');
          toast(data.blocks_enabled ? 'Bloqueos activados ‚úÖ' : 'Bloqueos desactivados ‚õî');
          await loadBlockRules();
        } catch (e) {
          toast(e.message || 'Error al cambiar estado');
        } finally {
          if (btn) btn.disabled = false;
        }
      }

      function onNewBlockModeChange() {
        const mode = byId('newBlockMode')?.value;
        const rangeDiv = byId('newBlockDateRange');
        if (rangeDiv) rangeDiv.style.display = (mode === 'range') ? 'flex' : 'none';
      }

      async function agregarReglaBloqueo() {
        const hourFrom = byId('newBlockFrom')?.value;
        const hourTo = byId('newBlockTo')?.value;
        const mode = byId('newBlockMode')?.value;
        const dateFrom = byId('newBlockDateFrom')?.value;
        const dateTo = byId('newBlockDateTo')?.value;
        const label = byId('newBlockLabel')?.value?.trim();
        const msgEl = byId('blockAddMsg');

        if (!hourFrom || !hourTo) {
          if (msgEl) { msgEl.textContent = '‚ùå Seleccion√° horario desde y hasta.'; msgEl.style.color = '#e74c3c'; }
          return;
        }
        if (hourFrom > hourTo) {
          if (msgEl) { msgEl.textContent = '‚ùå "Desde" debe ser menor o igual a "Hasta".'; msgEl.style.color = '#e74c3c'; }
          return;
        }
        if (mode === 'range' && (!dateFrom || !dateTo)) {
          if (msgEl) { msgEl.textContent = '‚ùå Eleg√≠ las fechas desde y hasta.'; msgEl.style.color = '#e74c3c'; }
          return;
        }

        const applyAll = (mode === 'all');
        const btn = byId('btnAddBlockRule');
        if (btn) { btn.disabled = true; btn.textContent = 'Guardando‚Ä¶'; }
        if (msgEl) msgEl.textContent = '';

        try {
          const payload = {
            hour_from: hourFrom,
            hour_to: hourTo,
            apply_all: applyAll,
            label: label || null,
            ...(applyAll ? {} : { date_from: dateFrom, date_to: dateTo })
          };
          const res = await fetch(`${API_BASE}/api/admin/block-rules`, {
            method: 'POST',
            headers: adminHeaders({ 'Content-Type': 'application/json' }),
            body: JSON.stringify(payload)
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.detail || 'Error al agregar regla');

          const affected = (data.slots_affected || []).join(', ');
          if (msgEl) {
            msgEl.style.color = '#27ae60';
            msgEl.textContent = `‚úÖ Regla agregada. Horarios afectados: ${affected}`;
          }
          toast('Regla de bloqueo agregada ‚úÖ');

          // Limpiar formulario
          const lb = byId('newBlockLabel'); if (lb) lb.value = '';

          await loadBlockRules();
        } catch (e) {
          if (msgEl) { msgEl.style.color = '#e74c3c'; msgEl.textContent = `‚ùå ${e.message}`; }
          toast(e.message || 'Error al agregar regla');
        } finally {
          if (btn) { btn.disabled = false; btn.textContent = 'Agregar regla'; }
        }
      }

      async function eliminarReglaBloqueo(ruleId) {
        if (!confirm('¬øEliminar esta regla de bloqueo?')) return;
        try {
          const res = await fetch(`${API_BASE}/api/admin/block-rules/${ruleId}`, {
            method: 'DELETE', headers: adminHeaders()
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.detail || 'Error al eliminar');
          toast('Regla eliminada ‚úÖ');
          await loadBlockRules();
        } catch (e) {
          toast(e.message || 'Error al eliminar regla');
        }
      }

      async function cambiarCredenciales() {
        const new_username = byId('newAdminUser')?.value?.trim();
        const new_password = byId('newAdminPass')?.value?.trim();
        const msgEl = byId('credsMsg');

        if (!new_username || !new_password) {
          if (msgEl) { msgEl.textContent = '‚ùå Usuario y contrase√±a son obligatorios.'; msgEl.style.color = '#e74c3c'; }
          return;
        }

        if (!confirm('¬øEst√°s seguro de cambiar el usuario y contrase√±a? Deber√°s usar los nuevos para entrar la pr√≥xima vez.')) return;

        if (msgEl) msgEl.textContent = 'Guardando...';

        try {
          const res = await fetch(`${API_BASE}/api/admin/change-creds`, {
            method: 'POST',
            headers: adminHeaders({ 'Content-Type': 'application/json' }),
            body: JSON.stringify({ new_username, new_password })
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.detail || 'Error al actualizar');

          if (msgEl) { msgEl.textContent = '‚úÖ Credenciales actualizadas correctamente.'; msgEl.style.color = '#27ae60'; }
          toast('Usuario y clave actualizados ‚úÖ');

          // Limpiar inputs
          byId('newAdminUser').value = '';
          byId('newAdminPass').value = '';

        } catch (e) {
          if (msgEl) { msgEl.textContent = `‚ùå ${e.message}`; msgEl.style.color = '#e74c3c'; }
          toast(e.message || 'Error al actualizar credenciales');
        }
      }

      async function resetearTodo() {
        if (!confirm("‚ö†Ô∏è ¬°ADVERTENCIA CR√çTICA!\n\nEsto borrar√° TODOS los bloqueos manuales que hayas hecho d√≠a por d√≠a en el pasado.\n\nTodo el calendario volver√° a los horarios est√°ndar por defecto. Esta acci√≥n no se puede deshacer.\n\n¬øEst√°s absolutamente seguro?")) return;

        try {
          const res = await fetch(`${API_BASE}/api/availability/all`, {
            method: 'DELETE', headers: adminHeaders()
          });
          if (!res.ok) throw new Error("Error al resetear todo");
          toast("¬°Calendario reseteado por completo! üßπ");

          // Recargar vista actual
          const df = byId('dispFecha');
          if (df?.value) {
            dispState.loadedMonth = "";
            await loadDisponibilidad(df.value);
          }
        } catch (e) {
          toast(e.message || "Error al resetear");
        }
      }

      function toggleTabsMenu() {
        const vs = byId('viewSwitch');
        if (vs) vs.classList.toggle('open');
      }

      Object.assign(window.Admin, {
        login,
        logout: adminLogout,
        openModal,
        closeModal,
        aprobar,
        rechazar,
        eliminar,
        completar,
        anular,
        loadDisponibilidad,
        guardarDisponibilidad,
        toggleDia,
        limpiarHorarios,
        resetearTodo,
        loadVariables,
        guardarVariables,
        // Reglas de bloqueo
        loadBlockRules,
        toggleBlockRules,
        onNewBlockModeChange,
        agregarReglaBloqueo,
        eliminarReglaBloqueo,
        cambiarCredenciales,
        toggleTabsMenu,
      });

      /* =================== MODAL LOGIC =================== */
      function openModal(id, idx) {
        if (!isAdminView()) return;
        if (!token) { adminLogout(); return; }

        let s = null;
        if (id != null) {
          const sid = String(id);
          s = (solicitudes || []).find(x => String(getId(x)) === sid);
          if (!s) {
            s = (calendarSolicitudes || []).find(x => String(getId(x)) === sid);
          }
        }
        if (!s && Number.isInteger(idx) && idx >= 0 && idx < (solicitudes || []).length) {
          s = solicitudes[idx];
        }
        if (!s) { toast('No se encontr√≥ la solicitud'); return; }

        selected = s;
        const st = String(s.estado || "").toLowerCase();

        const btnConfirm = document.querySelector(".btn-ok");
        const btnReject = document.querySelector(".btn-reject");

        // Nuevos botones
        const btnComplete = document.querySelector(".btn-complete");
        const btnVoid = document.querySelector(".btn-void");

        // Reglas de visibilidad
        let showCR = false; // Confirm/Reject
        let showCA = false; // Complete/Anular

        if (st === 'sent' || st === 'rechazado' || st === 'pending') {
          showCR = true;
        } else if (st === 'confirmado') {
          showCA = true;
        }

        if (btnConfirm) btnConfirm.style.display = showCR ? "inline-flex" : "none";
        if (btnReject) btnReject.style.display = showCR ? "inline-flex" : "none";

        if (btnComplete) btnComplete.style.display = showCA ? "inline-flex" : "none";
        if (btnVoid) btnVoid.style.display = showCA ? "inline-flex" : "none";


        // Llenar datos (tu c√≥digo existente...)
        const tiempo_viaje_min = coalesce(
          s.tiempo_viaje_min,
          (s.tramo_base_origen_min && s.tramo_origen_destino_min)
            ? Number(s.tramo_base_origen_min) + Number(s.tramo_origen_destino_min) + Number(s.tramo_destino_base_min || 0)
            : null
        );
        const tiempo_servicio_min = coalesce(s.tiempo_servicio_min, null);
        const tiempo_carga_desc_min = coalesce(s.tiempo_carga_descarga_min, s.tiempo_servicio_min);
        const costo_tiempo = coalesce(
          s.costo_tiempo,
          (s.costo_tiempo_base != null && s.mantenimiento != null)
            ? (Number(s.costo_tiempo_base) + Number(s.mantenimiento))
            : null
        );

        const se = (id, val) => { const el = byId(id); if (el) el.textContent = val; };
        se('m_cliente', s.nombre_cliente || '-');
        se('m_tel', s.telefono || '-');
        se('m_tipo', s.tipo_carga || '-');
        se('m_fecha', s.fecha_turno || s.fecha || '-');
        se('m_hora', s.hora_turno || '-');
        se('m_ayudante', s.ayudante ? 'S√≠' : 'No');
        se('m_estado', s.estado || '-');
        se('m_origen', s.origen || '-');
        se('m_destino', s.destino || '-');

        se('m_dist_km', (s.dist_km != null ? Number(s.dist_km).toFixed(3).replace('.', ',') : '-'));
        se('m_tiempo_viaje', (tiempo_viaje_min != null ? `${tiempo_viaje_min} min` : '-'));
        se('m_tiempo_servicio', (tiempo_servicio_min != null ? `${tiempo_servicio_min} min` : '-'));
        se('m_tiempo_carga_desc', (tiempo_carga_desc_min != null ? `${tiempo_carga_desc_min} min` : '-'));

        se('m_costo_tiempo', peso(costo_tiempo));
        se('m_costo_combustible', peso(s.costo_combustible));
        se('m_costo_ayudante', peso(s.costo_ayudante));
        se('m_total', peso(s.monto_estimado));

        byId('overlay')?.classList.add('open');
      }

      (function initAdmin() {
        const NEED = ['authFlag', 'tbody', 'loginForm'];
        const hasAdmin = () => NEED.every(id => document.getElementById(id));
        let inited = false;

        function safeInit() {
          if (inited || !hasAdmin()) return;
          inited = true;

          // ‚úÖ RESTAURA sesi√≥n LOCAL (solo pesta√±a) si exist√≠a
          if (!isSessionValid()) {
            adminLogout();
          } else {
            token = "ui-session";
            setAuthUI(true);
            startExpiryTimer();
            loadSolicitudes();
          }

          document.getElementById('loginForm')
            ?.addEventListener('submit', (e) => { e.preventDefault(); login(); });

          byId('dispFecha')?.addEventListener('change', (e) => {
            Admin.loadDisponibilidad(e.target.value);
          });

          byId('btnToggleDia')?.addEventListener('click', () => {
            const d = byId('dispFecha')?.value;
            if (!d) return toast("Eleg√≠ una fecha");
            Admin.toggleDia(d);
          });

          byId('btnLimpiarDia')?.addEventListener('click', () => {
            const d = byId('dispFecha')?.value;
            if (!d) return toast("Eleg√≠ una fecha");
            Admin.limpiarHorarios(d);
          });

          byId('btnGuardarDia')?.addEventListener('click', () => {
            const d = byId('dispFecha')?.value;
            if (!d) return toast("Eleg√≠ una fecha");
            Admin.guardarDisponibilidad(d);
          });

          byId('btnGuardarVars')?.addEventListener('click', () => {
            Admin.guardarVariables();
          });

          // Inicializar fechas m√≠nimas del formulario de reglas de bloqueo
          const todayIso = new Date().toISOString().split('T')[0];
          const bdf = byId('newBlockDateFrom'); if (bdf) { bdf.min = todayIso; bdf.value = todayIso; }
          const bdt = byId('newBlockDateTo'); if (bdt) { bdt.min = todayIso; bdt.value = todayIso; }
        }

        safeInit();
        requestAnimationFrame(safeInit);
        const mo = new MutationObserver(() => safeInit());
        mo.observe(document, { childList: true, subtree: true });
        const stop = setInterval(() => { if (inited) { mo.disconnect(); clearInterval(stop); } }, 300);
      })();


      // ‚úÖ LOGICA DE PESTA√ëAS UNIFICADA

      function switchTab(panelId, tabId) {
        const panels = ['panelSolicitudes', 'panelCalendario', 'panelDisponibilidad', 'panelVariables', 'panelCredenciales'];
        const tabs = ['tabSolicitudes', 'tabCalendario', 'tabDisponibilidad', 'tabVariables', 'tabCredenciales'];

        panels.forEach(pId => {
          const el = document.getElementById(pId);
          if (el) el.style.display = (pId === panelId) ? 'block' : 'none';
        });

        tabs.forEach(tId => {
          const el = document.getElementById(tId);
          if (el) el.classList.toggle('active', tId === tabId);
        });

        // Cerrar men√∫ mobile al elegir
        const vs = byId('viewSwitch');
        if (vs && vs.classList.contains('open')) vs.classList.remove('open');
      }
      (function initTabs() {
        const tSol = byId('tabSolicitudes');
        const tCal = byId('tabCalendario');
        const tDisp = byId('tabDisponibilidad');
        const tVars = byId('tabVariables');

        tSol?.addEventListener('click', () => {
          switchTab('panelSolicitudes', 'tabSolicitudes');
          // Cargar datos si hace falta
          loadSolicitudes();
        });

        tCal?.addEventListener('click', async () => {
          switchTab('panelCalendario', 'tabCalendario');
          await loadCalendarConfirmed();
          renderCalendar();
        });

        tDisp?.addEventListener('click', async () => {
          switchTab('panelDisponibilidad', 'tabDisponibilidad');
          const df = byId('dispFecha');
          if (df && !df.value) {
            const now = new Date();
            df.value = now.toISOString().slice(0, 10);
          }
          if (df?.value) loadDisponibilidad(df.value);
          // Cargar reglas de bloqueo al entrar al panel
          Admin.loadBlockRules();
        });

        tVars?.addEventListener('click', () => {
          switchTab('panelVariables', 'tabVariables');
          loadVariables();
        });

        byId('tabCredenciales')?.addEventListener('click', () => {
          switchTab('panelCredenciales', 'tabCredenciales');
        });

        // Sub-tabs de solicitudes (Pendientes / Historicos)
        const tPend = byId('tabReqPend');
        const tHist = byId('tabReqHist');
        const hTool = byId('histToolbar');

        tPend?.addEventListener('click', () => {
          tPend.classList.add('active');
          tHist?.classList.remove('active');
          if (hTool) hTool.style.display = 'none';
          loadSolicitudes('pending');
        });

        tHist?.addEventListener('click', () => {
          tHist.classList.add('active');
          tPend?.classList.remove('active');
          if (hTool) hTool.style.display = 'flex';
          loadSolicitudes('historicos');
        });

      })();

    })();
  </script>

  <script>
    (function () {
      const page = document.body.dataset.page; // "inicio" | "presupuesto" | "admin"

      document.querySelectorAll(".nav-links a").forEach(a => {
        a.classList.toggle("active", a.dataset.view === page);
      });
    })();
  </script>



  <!-- ‚úÖ NO cargar spa.js ac√°. Dejalo solo en index -->
</body>

</html>