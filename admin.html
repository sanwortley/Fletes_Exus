<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Admin ‚Äî Fletes Javier</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--dorado:#ffd000;--ok:#b7f7c0;--warn:#ffe29d;--bad:#f8c0c0}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;background:#0f1115;color:#eaeaea}
    .navbar{display:flex;align-items:center;justify-content:space-between;padding:14px 22px;background:#111;color:#fff}
    .navbar a{color:#fff;text-decoration:none;margin-left:14px;padding:8px 12px;border-radius:10px}
    .navbar a:hover{background:#222}
    .wrap{max-width:1100px;margin:22px auto;padding:0 16px}
    .card{background:#151821;border:1px solid #232634;border-radius:14px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,.2)}
    h1{margin:6px 0 18px}
    .login{display:flex;gap:10px;align-items:center;margin-bottom:10px}
    input{background:#0f1218;border:1px solid #2a2e35;color:#eaeaea;padding:10px;border-radius:10px}
    .btn{background:var(--dorado);border:0;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer;color:#121212}
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th,td{text-align:left;padding:10px 12px}
    th{opacity:.8}
    tr.row{background:#131621;border:1px solid #232634}
    .pill{padding:6px 10px;border-radius:999px;font-weight:700}
    .pend{background:var(--warn);color:#222}
    .conf{background:var(--ok);color:#124012}
    .rech{background:var(--bad);color:#5a1111}
    .actions{display:flex;gap:8px}
    .btn-sec{background:#303544;color:#eaeaea;border:1px solid #3a3f50}
    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:16px}
    .modal .box{background:#141820;color:#eaeaea;border:1px solid #232634;border-radius:14px;max-width:720px;width:100%;padding:18px}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row2 .full{grid-column:1/-1}
    .btn-danger{background:#ff6b6b;color:#111}
  </style>
</head>
<body>
  <nav class="navbar">
    <div>üöö Fletes Javier ‚Äî Admin</div>
    <div>
      <a href="./index.html">Inicio</a>
      <a href="./presupuesto.html">Presupuesto</a>
      <a href="./admin.html">Admin</a>
    </div>
  </nav>

  <div class="wrap">
    <h1>Panel de Administraci√≥n</h1>

    <div class="card">
      <div class="login">
        <input id="u" placeholder="Usuario" autocomplete="username" />
        <input id="p" type="password" placeholder="Contrase√±a" autocomplete="current-password" />
        <button class="btn" id="doLogin">Iniciar sesi√≥n</button>
        <span id="authState" style="margin-left:10px;opacity:.8">No autenticado</span>
      </div>

      <div id="list"></div>
    </div>
  </div>

  <!-- Modal Detalles -->
  <div class="modal" id="modal">
    <div class="box">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>Detalles de solicitud</h3>
        <button class="btn-sec" onclick="hideModal()">Cerrar</button>
      </div>
      <div id="md-body"></div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn" id="md-confirm">Confirmar</button>
        <button class="btn-sec" id="md-reject">Rechazar</button>
        <button class="btn-danger" id="md-delete" title="Solo si est√° rechazado">Eliminar</button>
      </div>
    </div>
  </div>

  <script>
    const apiBase = "http://127.0.0.1:8000";
    let token = null;
    let items = [];
    let selected = null;

    const $ = s => document.querySelector(s);
    const list = $("#list");
    const authState = $("#authState");

    $("#doLogin").onclick = async () => {
      const username = $("#u").value.trim();
      const password = $("#p").value.trim();
      if(!username || !password){ alert("Complet√° usuario y contrase√±a"); return; }
      const res = await fetch(`${apiBase}/api/login`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({username,password})
      });
      const data = await res.json();
      if(!res.ok){ alert(data.detail || "Error"); return; }
      token = data.token;
      authState.textContent = "Autenticado";
      load();
    };

    async function load(){
      list.innerHTML = "<p>Cargando...</p>";
      const res = await fetch(`${apiBase}/api/requests`, {
        headers:{ Authorization: `Bearer ${token}` }
      });
      const data = await res.json();
      if(!res.ok){ list.innerHTML = `<p>Error: ${data.detail||"?"}</p>`; return; }
      items = data.items || [];
      renderTable();
    }

    function pill(est){
      if(est === "confirmado") return `<span class="pill conf">CONFIRMADO</span>`;
      if(est === "rechazado") return `<span class="pill rech">RECHAZADO</span>`;
      return `<span class="pill pend">PENDIENTE</span>`;
    }

    function renderTable(){
      if(!items.length){ list.innerHTML = "<p>Sin solicitudes a√∫n.</p>"; return; }
      list.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Cliente</th>
              <th>Tipo</th>
              <th>Fecha</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            ${items.map(x=>`
              <tr class="row">
                <td><div><b>${x.nombre_cliente}</b><br><small>${x.telefono||""}</small></div></td>
                <td>${x.tipo_carga}</td>
                <td>${x.fecha||"-"}</td>
                <td>${pill(x.estado)}</td>
                <td class="actions">
                  <button class="btn-sec" onclick='openDetails("${x.id}")'>Detalles</button>
                </td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }

    function fmt(n){ return (n??0).toLocaleString("es-AR"); }

    function openDetails(id){
      selected = items.find(x=>x.id===id);
      if(!selected) return;
      $("#md-delete").disabled = selected.estado !== "rechazado";

      $("#md-body").innerHTML = `
        <div class="row2">
          <div><b>Cliente</b><br>${selected.nombre_cliente}</div>
          <div><b>Tel√©fono</b><br>${selected.telefono||"-"}</div>
          <div><b>Tipo</b><br>${selected.tipo_carga}</div>
          <div><b>Fecha</b><br>${selected.fecha||"-"}</div>
          <div class="full"><b>Origen</b><br>${selected.origen}</div>
          <div class="full"><b>Destino</b><br>${selected.destino}</div>
          <div><b>Distancia (km)</b><br>${selected.dist_km}</div>
          <div><b>Manejo (min)</b><br>${selected.tiempo_viaje_min}</div>
          <div><b>Servicio (min)</b><br>${selected.tiempo_servicio_min}</div>
          <div><b>Ayudante</b><br>${selected.ayudante ? "S√≠" : "No"}</div>
          <div><b>Costo tiempo</b><br>$ ${fmt(selected.costo_tiempo)}</div>
          <div><b>Combustible</b><br>$ ${fmt(selected.costo_combustible)}</div>
          <div><b>Ayudante</b><br>$ ${fmt(selected.costo_ayudante)}</div>
          <div class="full"><b>Total</b><br><b>$ ${fmt(selected.monto_estimado)}</b></div>
          <div><b>Estado</b><br>${selected.estado}</div>
          <div><b>ID</b><br>${selected.id}</div>
        </div>
      `;
      showModal();
    }

    $("#md-confirm").onclick = async () => {
      if(!selected) return;
      const res = await fetch(`${apiBase}/api/requests/${selected.id}/confirm`, {
        method:"POST",
        headers:{ Authorization:`Bearer ${token}` }
      });
      if(res.ok){ hideModal(); await load(); } else { alert("No se pudo confirmar"); }
    };

    $("#md-reject").onclick = async () => {
      if(!selected) return;
      const res = await fetch(`${apiBase}/api/requests/${selected.id}/reject`, {
        method:"POST",
        headers:{ Authorization:`Bearer ${token}` }
      });
      if(res.ok){ hideModal(); await load(); } else { alert("No se pudo rechazar"); }
    };

    $("#md-delete").onclick = async () => {
      if(!selected) return;
      if(selected.estado !== "rechazado"){ alert("Solo puede eliminarse si est√° rechazado."); return; }
      if(!confirm("¬øEliminar esta solicitud?")) return;
      const res = await fetch(`${apiBase}/api/requests/${selected.id}`, {
        method:"DELETE",
        headers:{ Authorization:`Bearer ${token}` }
      });
      if(res.ok){ hideModal(); await load(); } else { alert("No se pudo eliminar"); }
    };

    function showModal(){ $("#modal").style.display="flex"; }
    function hideModal(){ $("#modal").style.display="none"; }

    // Si quer√©s, auto-login en dev:
    // (descomentar y setear valores, o usar el bot√≥n)
    // (async () => {
    //   const r = await fetch(`${apiBase}/api/login`, {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:"admin",password:"admin123"})});
    //   const j = await r.json(); if(r.ok){ token=j.token; authState.textContent="Autenticado"; load(); }
    // })();
  </script>
</body>
</html>
